<!DOCTYPE html>
<html lang="zh-cn">
<head><meta name="generator" content="Hexo 3.9.0">
  <title>Sequelize - 为企业级框架和应用而生</title>
  <meta charset="utf-8">
  <meta name="description" content="index.description">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="icon" href="/images/favicon.png" type="image/x-icon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css">
<link rel="stylesheet" href="/css/index.css">

    <script>
    !function(t,e,a,r,c){t.TracertCmdCache=t.TracertCmdCache||[],t[c]=window[c]||
      {_isInit:!0,call:function(){t.TracertCmdCache.push(arguments)},
      start:function(t){this.call('start',t)}},t[c].l=new Date;
      var n=e.createElement(a),s=e.getElementsByTagName(a)[0];
      n.async=!0,n.src=r,s.parentNode.insertBefore(n,s)}
    (window,document,'script','https://tracert.alipay.com/tracert.js','Tracert');
      Tracert.start({
        plugins: [ 'BucName' ],
        spmAPos: 'a454',
        spmBPos: 'b4893',
      });
    </script>
  
<!-- Hotjar Tracking Code for https://eggjs.org -->
<script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:1089836,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
</script>

</head>
<body>
  <div class="nav">
  <header>
    <a href="/zh-cn/" class="nav-logo leftpadding" alt="egg"><img src="https://zos.alipayobjects.com/rmsportal/VTcUYAaoKqXyHJbLAPyF.svg"></a>
    <ul class="nav-item">
      <li>
        <form id="search-form">
          <input type="text" id="search-query" class="search-query st-default-search-input">
        </form>
      </li>
      <li><a href="/zh-cn/intro/" alt="指南">指南</a></li><li><a href="/api/" alt="API">API</a></li><li><a href="/zh-cn/tutorials/index.html" alt="教程">教程</a></li><li><a href="https://github.com/search?q=topic%3Aegg-plugin&type=Repositories" alt="插件">插件</a></li><li><a href="https://github.com/eggjs/egg/releases" alt="发布日志">发布日志</a></li>
      
      
        <li class="translations">
          <a class="nav-link">切换语言</a>
          <span class="arrow"></span><ul id="dropdownContent" class="dropdown-content"><li><a id="en" href="/en/tutorials/sequelize.html">English</a></li><li><a id="zh-cn" href="/zh-cn/tutorials/sequelize.html" style="color: #22ab28">中文</a></li></ul>
        </li>
      
      <li><iframe src="https://ghbtns.com/github-btn.html?user=eggjs&repo=egg&type=star&count=true" frameborder="0" scrolling="0" width="150px" height="20px"></iframe></li>
    </ul>
    <a id="mobileTrigger" href="#" class="mobile-trigger">
      <ul>
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </a>
  </header>
</div>

  <div id="container" class="container">
    <div class="page-main">
  <aside id="mobileAside" class="aside">
  <div class="mobile-menu">
    <ul>
      <li><a href="/zh-cn/intro/" alt="指南">指南</a></li><li><a href="/api/" alt="API">API</a></li><li><a href="/zh-cn/tutorials/index.html" alt="教程">教程</a></li><li><a href="https://github.com/search?q=topic%3Aegg-plugin&type=Repositories" alt="插件">插件</a></li><li><a href="https://github.com/eggjs/egg/releases" alt="发布日志">发布日志</a></li>
      
      
        <li class="translations">
          <a class="nav-link">切换语言</a>
          <span class="arrow"></span><ul id="dropdownContent" class="dropdown-content"><li><a id="en" href="/en/tutorials/sequelize.html">English</a></li><li><a id="zh-cn" href="/zh-cn/tutorials/sequelize.html" style="color: #22ab28">中文</a></li></ul>
        </li>
      
    </ul>
  </div>
  <dl><dt id="title-Intro" style="cursor: pointer;" class="aside-title">新手指南<a id="collapse-icon-Intro" class="icon opend"></a></dt><dd id="panel-Intro"><ul><li><a href="/zh-cn/intro/index.html" class="menu-link">Egg.js 是什么？</a></li><li><a href="/zh-cn/intro/egg-and-koa.html" class="menu-link">Egg.js 和 Koa</a></li><li><a href="/zh-cn/intro/quickstart.html" class="menu-link">快速入门</a></li><li><a href="/zh-cn/tutorials/progressive.html" class="menu-link">渐进式开发</a></li><li><a href="/zh-cn/migration.html" class="menu-link">2.x 升级指南</a></li></ul></dd><dt id="title-Basics" style="cursor: pointer;" class="aside-title">基础功能<a id="collapse-icon-Basics" class="icon opend"></a></dt><dd id="panel-Basics"><ul><li><a href="/zh-cn/basics/structure.html" class="menu-link">目录结构</a></li><li><a href="/zh-cn/basics/objects.html" class="menu-link">内置对象</a></li><li><a href="/zh-cn/basics/env.html" class="menu-link">运行环境</a></li><li><a href="/zh-cn/basics/config.html" class="menu-link">配置</a></li><li><a href="/zh-cn/basics/middleware.html" class="menu-link">中间件</a></li><li><a href="/zh-cn/basics/router.html" class="menu-link">路由（Router）</a></li><li><a href="/zh-cn/basics/controller.html" class="menu-link">控制器（Controller）</a></li><li><a href="/zh-cn/basics/service.html" class="menu-link">服务（Service）</a></li><li><a href="/zh-cn/basics/plugin.html" class="menu-link">插件</a></li><li><a href="/zh-cn/basics/schedule.html" class="menu-link">定时任务</a></li><li><a href="/zh-cn/basics/extend.html" class="menu-link">框架扩展</a></li><li><a href="/zh-cn/basics/app-start.html" class="menu-link">启动自定义</a></li></ul></dd><dt id="title-Core" style="cursor: pointer;" class="aside-title">核心功能<a id="collapse-icon-Core" class="icon opend"></a></dt><dd id="panel-Core"><ul><li><a href="/zh-cn/core/development.html" class="menu-link">本地开发</a></li><li><a href="/zh-cn/core/unittest.html" class="menu-link">单元测试</a></li><li><a href="/zh-cn/core/deployment.html" class="menu-link">应用部署</a></li><li><a href="/zh-cn/core/logger.html" class="menu-link">日志</a></li><li><a href="/zh-cn/core/httpclient.html" class="menu-link">HttpClient</a></li><li><a href="/zh-cn/core/cookie-and-session.html" class="menu-link">Cookie and Session</a></li><li><a href="/zh-cn/core/cluster-and-ipc.html" class="menu-link">多进程模型和进程间通讯</a></li><li><a href="/zh-cn/core/view.html" class="menu-link">模板渲染</a></li><li><a href="/zh-cn/core/error-handling.html" class="menu-link">异常处理</a></li><li><a href="/zh-cn/core/security.html" class="menu-link">安全</a></li><li><a href="/zh-cn/core/i18n.html" class="menu-link">国际化</a></li></ul></dd><dt id="title-Tutorials" style="cursor: pointer;" class="aside-title">教程<a id="collapse-icon-Tutorials" class="icon opend"></a></dt><dd id="panel-Tutorials"><ul><li><a href="/zh-cn/tutorials/mysql.html" class="menu-link">MySQL</a></li><li><a href="/zh-cn/tutorials/sequelize.html" class="menu-link">Sequelize</a></li><li><a href="/zh-cn/tutorials/restful.html" class="menu-link">RESTful API</a></li><li><a href="/zh-cn/tutorials/passport.html" class="menu-link">Passport 鉴权</a></li><li><a href="/zh-cn/tutorials/socketio.html" class="menu-link">Socket.IO</a></li><li><a href="/zh-cn/tutorials/assets.html" class="menu-link">静态资源</a></li><li><a href="/zh-cn/tutorials/typescript.html" class="menu-link">TypeScript</a></li><li><a href="/zh-cn/tutorials/proxy.html" class="menu-link">前置代理模式</a></li></ul></dd><dt id="title-Advanced" style="cursor: pointer;" class="aside-title">进阶<a id="collapse-icon-Advanced" class="icon opend"></a></dt><dd id="panel-Advanced"><ul><li><a href="/zh-cn/advanced/loader.html" class="menu-link">加载器（Loader）</a></li><li><a href="/zh-cn/advanced/plugin.html" class="menu-link">插件开发</a></li><li><a href="/zh-cn/advanced/framework.html" class="menu-link">框架开发</a></li><li><a href="/zh-cn/advanced/cluster-client.html" class="menu-link">多进程研发模式增强</a></li><li><a href="/zh-cn/advanced/view-plugin.html" class="menu-link">模板插件开发规范</a></li><li><a href="/zh-cn/style-guide.html" class="menu-link">代码风格指南</a></li></ul></dd><dt id="title-Community" style="cursor: pointer;" class="aside-title">社区<a id="collapse-icon-Community" class="icon opend"></a></dt><dd id="panel-Community"><ul><li><a href="/zh-cn/contributing.html" class="menu-link">如何贡献</a></li><li><a href="/zh-cn/resource.html" class="menu-link">资源</a></li><li><a href="/zh-cn/faq.html" class="menu-link">常见问题</a></li></ul></dd></dl>
</aside>
<script>
var mobileTrigger = document.getElementById('mobileTrigger');
var mobileAside = document.getElementById('mobileAside');

var expandMenu = function(title) {
  // handle icon
  const collapseIcon = document.getElementById('collapse-icon-' + title);
  if (collapseIcon) {
    collapseIcon.className = 'icon opend';
  }
  // handle panelEle
  const panelEle = document.getElementById('panel-' + title);
  if (panelEle) {
    panelEle.className = '';
  }
}

var collapseMenu = function(title) {
  // handle icon
  const collapseIcon = document.getElementById('collapse-icon-' + title);
  if (collapseIcon) {
    collapseIcon.className = 'icon closed';
  }
  // handle panelEle
  const panelEle = document.getElementById('panel-' + title);
  if (panelEle) {
    panelEle.className = 'aside-panel-hidden';
  }
}

mobileAside.onclick = function(e) {
  const targetId = e.target.id;
  if (targetId && (targetId.indexOf('title-') > -1 || targetId.indexOf('collapse-icon-') > -1)) {
    const title = targetId.replace('title-', '').replace('collapse-icon-', '');
    try { 
      // the the browser may have no localStroage or JSON.parse may throw exception.
      const menuInfo = JSON.parse(window.localStorage.getItem('menuInfo'));
        
      // current menu status
      const curClosed = menuInfo[title] ? menuInfo[title].closed : false; // default false

      // change UI
      curClosed ? expandMenu(title) : collapseMenu(title);

      // save menuInfo to localStorage
      menuInfo[title] = { closed: !curClosed } // opposite
      window.localStorage.setItem('menuInfo', JSON.stringify(menuInfo));
    } catch (e) {}
  }
};

mobileTrigger.onclick = function(e) {
  e.preventDefault();
  if (mobileAside.className.indexOf('mobile-show') === -1) {
    mobileAside.className += ' mobile-show';
  } else {
    mobileAside.className = 'aside';
  }
};

(function() {
  // save data to localStorage because the page will refresh when user change the url.
  let menuInfo;
  try { 
    // the the browser may have no localStroage or JSON.parse may throw exception.
    menuInfo = JSON.parse(window.localStorage.getItem('menuInfo'));
    if (!menuInfo) {
      menuInfo = {};
      window.localStorage.setItem('menuInfo', JSON.stringify(menuInfo));
    }
  } catch (e) {
    menuInfo = {}; // default {}
  }

  for (const title in menuInfo) {
    if (menuInfo[title] && menuInfo[title].closed) { // menu in closed status.
      collapseMenu(title);
    } else {
      expandMenu(title);
    }
  }

  // highlight menu
  const pathname = window.location.pathname;
  const selector = `a[href="${pathname}"].menu-link,a[href="${pathname}index.html"].menu-link`;
  const menuItem = mobileAside.querySelector(selector);
  if (menuItem) { menuItem.className += ' highlight'; }
})();
</script>


  <div class="content">
    <div class="doc">
      <article class="markdown-body">
        <h1>Sequelize</h1>
          <p><a href="./mysql.html">前面的章节中</a>，我们介绍了如何在框架中通过 <a href="https://github.com/eggjs/egg-mysql" target="_blank" rel="noopener">egg-mysql</a> 插件来访问数据库。而在一些较为复杂的应用中，我们可能会需要一个 ORM 框架来帮助我们管理数据层的代码。而在 Node.js 社区中，<a href="http://docs.sequelizejs.com/" target="_blank" rel="noopener">sequelize</a> 是一个广泛使用的 ORM 框架，它支持 MySQL、PostgreSQL、SQLite 和 MSSQL 等多个数据源。</p>
<p>本章节我们会通过开发一个对 MySQL 中 <code>users</code> 表的数据做 CURD 的例子来一步步介绍如何在 egg 项目中使用 sequelize。</p>
<h2 id="准备工作"><a class="markdown-anchor" href="#准备工作">#</a> 准备工作</h2>
<p>在这个例子中，我们会使用 sequelize 连接到 MySQL 数据源，因此在开始编写代码之前，我们需要先在本机上安装好 MySQL，如果是 MacOS，可以通过 homebrew 快速安装：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">brew install mysql</span><br><span class="line">brew services start mysql</span><br></pre></td></tr></table></figure>
<h2 id="初始化项目"><a class="markdown-anchor" href="#初始化项目">#</a> 初始化项目</h2>
<p>通过 <code>npm</code> 初始化一个项目:</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mkdir sequelize-project &amp;&amp; <span class="built_in">cd</span> sequelize-project</span><br><span class="line">$ npm init egg --<span class="built_in">type</span>=simple</span><br><span class="line">$ npm i</span><br></pre></td></tr></table></figure>
<p>安装并配置 <a href="https://github.com/eggjs/egg-sequelize" target="_blank" rel="noopener">egg-sequelize</a> 插件（它会辅助我们将定义好的 Model 对象加载到 app 和 ctx 上）和 <a href="https://github.com/sidorares/node-mysql2" target="_blank" rel="noopener">mysql2</a> 模块：</p>
<ul>
<li>安装</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install --save egg-sequelize mysql2</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>config/plugin.js</code> 中引入 egg-sequelize 插件</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">exports.sequelize = &#123;</span><br><span class="line">  enable: <span class="literal">true</span>,</span><br><span class="line">  package: <span class="string">'egg-sequelize'</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>在 <code>config/config.default.js</code> 中编写 sequelize 配置</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">config.sequelize = &#123;</span><br><span class="line">  dialect: <span class="string">'mysql'</span>,</span><br><span class="line">  host: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">  port: <span class="number">3306</span>,</span><br><span class="line">  database: <span class="string">'egg-sequelize-doc-default'</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>我们可以在不同的环境配置中配置不同的数据源地址，用于区分不同环境使用的数据库，例如我们可以新建一个 <code>config/config.unittest.js</code> 配置文件，写入如下配置，将单测时连接的数据库指向 <code>egg-sequelize-doc-unittest</code>。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">exports.sequelize = &#123;</span><br><span class="line">  dialect: <span class="string">'mysql'</span>,</span><br><span class="line">  host: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">  port: <span class="number">3306</span>,</span><br><span class="line">  database: <span class="string">'egg-sequelize-doc-unittest'</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>完成上面的配置之后，一个使用 sequelize 的项目就初始化完成了。<a href="https://github.com/eggjs/egg-sequelize" target="_blank" rel="noopener">egg-sequelize</a> 和 <a href="http://docs.sequelizejs.com/" target="_blank" rel="noopener">sequelize</a> 还支持更多的配置项，可以在他们的文档中找到。</p>
<h2 id="初始化数据库和-migrations"><a class="markdown-anchor" href="#初始化数据库和-migrations">#</a> 初始化数据库和 Migrations</h2>
<p>接下来我们先暂时离开 egg 项目的代码，设计和初始化一下我们的数据库。首先我们通过 mysql 命令在本地快速创建开发和测试要用到的两个 database：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mysql -u root -e <span class="string">'CREATE DATABASE IF NOT EXISTS `egg-sequelize-doc-default`;'</span></span><br><span class="line">mysql -u root -e <span class="string">'CREATE DATABASE IF NOT EXISTS `egg-sequelize-doc-unittest`;'</span></span><br></pre></td></tr></table></figure>
<p>然后我们开始设计 <code>users</code> 表，它有如下的数据结构：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`users`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT <span class="keyword">COMMENT</span> <span class="string">'primary key'</span>,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'user name'</span>,</span><br><span class="line">  <span class="string">`age`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'user age'</span>,</span><br><span class="line">  <span class="string">`created_at`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'created time'</span>,</span><br><span class="line">  <span class="string">`updated_at`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'updated time'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COMMENT</span>=<span class="string">'user'</span>;</span><br></pre></td></tr></table></figure>
<p>我们可以直接通过 mysql 命令将表直接建好，但是这并不是一个对多人协作非常友好的开发模式。在项目的演进过程中，每一个迭代都有可能对数据库数据结构做变更，怎样跟踪每一个迭代的数据变更，并在不同的环境（开发、测试、CI）和迭代切换中，快速变更数据结构呢？这时候我们就需要 <a href="http://docs.sequelizejs.com/manual/tutorial/migrations.html" target="_blank" rel="noopener">Migrations</a> 来帮我们管理数据结构的变更了。</p>
<p>sequelize 提供了 <a href="https://github.com/sequelize/cli" target="_blank" rel="noopener">sequelize-cli</a> 工具来实现 <a href="http://docs.sequelizejs.com/manual/tutorial/migrations.html" target="_blank" rel="noopener">Migrations</a>，我们也可以在 egg 项目中引入 sequelize-cli。</p>
<ul>
<li>安装 sequelize-cli</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install --save-dev sequelize-cli</span><br></pre></td></tr></table></figure>
<p>在 egg 项目中，我们希望将所有数据库 Migrations 相关的内容都放在 <code>database</code> 目录下，所以我们在项目根目录下新建一个 <code>.sequelizerc</code> 配置文件：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  config: path.join(__dirname, <span class="string">'database/config.json'</span>),</span><br><span class="line">  <span class="string">'migrations-path'</span>: path.join(__dirname, <span class="string">'database/migrations'</span>),</span><br><span class="line">  <span class="string">'seeders-path'</span>: path.join(__dirname, <span class="string">'database/seeders'</span>),</span><br><span class="line">  <span class="string">'models-path'</span>: path.join(__dirname, <span class="string">'app/model'</span>),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>初始化 Migrations 配置文件和目录</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npx sequelize init:config</span><br><span class="line">npx sequelize init:migrations</span><br></pre></td></tr></table></figure>
<p>执行完后会生成 <code>database/config.json</code> 文件和 <code>database/migrations</code> 目录，我们修改一下 <code>database/config.json</code> 中的内容，将其改成我们项目中使用的数据库配置：</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;development&quot;: &#123;</span><br><span class="line">    &quot;username&quot;: &quot;root&quot;,</span><br><span class="line">    &quot;password&quot;: null,</span><br><span class="line">    &quot;database&quot;: &quot;egg-sequelize-doc-default&quot;,</span><br><span class="line">    &quot;host&quot;: &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;dialect&quot;: &quot;mysql&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;test&quot;: &#123;</span><br><span class="line">    &quot;username&quot;: &quot;root&quot;,</span><br><span class="line">    &quot;password&quot;: null,</span><br><span class="line">    &quot;database&quot;: &quot;egg-sequelize-doc-unittest&quot;,</span><br><span class="line">    &quot;host&quot;: &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;dialect&quot;: &quot;mysql&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时 sequelize-cli 和相关的配置也都初始化好了，我们可以开始编写项目的第一个 Migration 文件来创建我们的一个 users 表了。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npx sequelize migration:generate --name=init-users</span><br></pre></td></tr></table></figure>
<p>执行完后会在 <code>database/migrations</code> 目录下生成一个 migration 文件(<code>${timestamp}-init-users.js</code>)，我们修改它来处理初始化 <code>users</code> 表：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 在执行数据库升级时调用的函数，创建 users 表</span></span><br><span class="line">  up: <span class="keyword">async</span> (queryInterface, Sequelize) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; INTEGER, DATE, STRING &#125; = Sequelize;</span><br><span class="line">    <span class="keyword">await</span> queryInterface.createTable(<span class="string">'users'</span>, &#123;</span><br><span class="line">      id: &#123; <span class="attr">type</span>: INTEGER, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">      name: STRING(<span class="number">30</span>),</span><br><span class="line">      age: INTEGER,</span><br><span class="line">      created_at: DATE,</span><br><span class="line">      updated_at: DATE,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// 在执行数据库降级时调用的函数，删除 users 表</span></span><br><span class="line">  down: <span class="keyword">async</span> queryInterface =&gt; &#123;</span><br><span class="line">    <span class="keyword">await</span> queryInterface.dropTable(<span class="string">'users'</span>);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>执行 migrate 进行数据库变更</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 升级数据库</span></span><br><span class="line">npx sequelize db:migrate</span><br><span class="line"><span class="comment"># 如果有问题需要回滚，可以通过 `db:migrate:undo` 回退一个变更</span></span><br><span class="line"><span class="comment"># npx sequelize db:migrate:undo</span></span><br><span class="line"><span class="comment"># 可以通过 `db:migrate:undo:all` 回退到初始状态</span></span><br><span class="line"><span class="comment"># npx sequelize db:migrate:undo:all</span></span><br></pre></td></tr></table></figure>
<p>执行之后，我们的数据库初始化就完成了。</p>
<h2 id="编写代码"><a class="markdown-anchor" href="#编写代码">#</a> 编写代码</h2>
<p>现在终于可以开始编写代码实现业务逻辑了，首先我们来在 <code>app/model/</code> 目录下编写 user 这个 Model：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; STRING, INTEGER, DATE &#125; = app.Sequelize;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> User = app.model.define(<span class="string">'user'</span>, &#123;</span><br><span class="line">    id: &#123; <span class="attr">type</span>: INTEGER, <span class="attr">primaryKey</span>: <span class="literal">true</span>, <span class="attr">autoIncrement</span>: <span class="literal">true</span> &#125;,</span><br><span class="line">    name: STRING(<span class="number">30</span>),</span><br><span class="line">    age: INTEGER,</span><br><span class="line">    created_at: DATE,</span><br><span class="line">    updated_at: DATE,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> User;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这个 Model 就可以在 Controller 和 Service 中通过 <code>app.model.User</code> 或者 <code>ctx.model.User</code> 访问到了，例如我们编写 <code>app/controller/users.js</code>：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/controller/users.js</span></span><br><span class="line"><span class="keyword">const</span> Controller = <span class="built_in">require</span>(<span class="string">'egg'</span>).Controller;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toInt</span>(<span class="params">str</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> str === <span class="string">'number'</span>) <span class="keyword">return</span> str;</span><br><span class="line">  <span class="keyword">if</span> (!str) <span class="keyword">return</span> str;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">parseInt</span>(str, <span class="number">10</span>) || <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> index() &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.ctx;</span><br><span class="line">    <span class="keyword">const</span> query = &#123; <span class="attr">limit</span>: toInt(ctx.query.limit), <span class="attr">offset</span>: toInt(ctx.query.offset) &#125;;</span><br><span class="line">    ctx.body = <span class="keyword">await</span> ctx.model.User.findAll(query);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> show() &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.ctx;</span><br><span class="line">    ctx.body = <span class="keyword">await</span> ctx.model.User.findByPk(toInt(ctx.params.id));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> create() &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.ctx;</span><br><span class="line">    <span class="keyword">const</span> &#123; name, age &#125; = ctx.request.body;</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> ctx.model.User.create(&#123; name, age &#125;);</span><br><span class="line">    ctx.status = <span class="number">201</span>;</span><br><span class="line">    ctx.body = user;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> update() &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.ctx;</span><br><span class="line">    <span class="keyword">const</span> id = toInt(ctx.params.id);</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> ctx.model.User.findByPk(id);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      ctx.status = <span class="number">404</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123; name, age &#125; = ctx.request.body;</span><br><span class="line">    <span class="keyword">await</span> user.update(&#123; name, age &#125;);</span><br><span class="line">    ctx.body = user;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> destroy() &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.ctx;</span><br><span class="line">    <span class="keyword">const</span> id = toInt(ctx.params.id);</span><br><span class="line">    <span class="keyword">const</span> user = <span class="keyword">await</span> ctx.model.User.findByPk(id);</span><br><span class="line">    <span class="keyword">if</span> (!user) &#123;</span><br><span class="line">      ctx.status = <span class="number">404</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">await</span> user.destroy();</span><br><span class="line">    ctx.status = <span class="number">200</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = UserController;</span><br></pre></td></tr></table></figure>
<p>最后我们将这个 controller 挂载到路由上：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/router.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; router, controller &#125; = app;</span><br><span class="line">  router.resources(<span class="string">'users'</span>, <span class="string">'/users'</span>, controller.users);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>针对 <code>users</code> 表的 CURD 操作的接口就开发完了，为了验证代码逻辑是否正确，我们接下来需要编写单元测试来验证。</p>
<h2 id="单元测试"><a class="markdown-anchor" href="#单元测试">#</a> 单元测试</h2>
<p>在编写测试之前，由于在前面的 egg 配置中，我们将单元测试环境和开发环境指向了不同的数据库，因此需要通过 Migrations 来初始化测试数据库的数据结构：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">NODE_ENV=<span class="built_in">test</span> npx sequelize db:migrate:up</span><br></pre></td></tr></table></figure>
<p>有数据库访问的单元测试直接写起来会特别繁琐，特别是很多接口我们需要创建一系列的数据才能进行，造测试数据是一个非常繁琐的过程。为了简化单测，我们可以通过 <a href="https://github.com/aexmachina/factory-girl" target="_blank" rel="noopener">factory-girl</a> 模块来快速创建测试数据。</p>
<ul>
<li>安装 <code>factory-girl</code> 依赖</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">npm install --save-dev factory-girl</span><br></pre></td></tr></table></figure>
<ul>
<li>定义 factory-girl 的数据模型到 <code>test/factories.js</code> 中</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// test/factories.js</span></span><br><span class="line"><span class="meta">'use strict'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> &#123; factory &#125; = <span class="built_in">require</span>(<span class="string">'factory-girl'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 可以通过 app.factory 访问 factory 实例</span></span><br><span class="line">  app.factory = factory;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 定义 user 和默认数据</span></span><br><span class="line">  factory.define(<span class="string">'user'</span>, app.model.User, &#123;</span><br><span class="line">    name: factory.sequence(<span class="string">'User.name'</span>, n =&gt; <span class="string">`name_<span class="subst">$&#123;n&#125;</span>`</span>),</span><br><span class="line">    age: <span class="number">18</span>,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>初始化文件 <code>test/.setup.js</code>，引入 factory，并确保测试执行完后清理数据，避免被影响。</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; app &#125; = <span class="built_in">require</span>(<span class="string">'egg-mock/bootstrap'</span>);</span><br><span class="line"><span class="keyword">const</span> factories = <span class="built_in">require</span>(<span class="string">'./factories'</span>);</span><br><span class="line"></span><br><span class="line">before(<span class="function"><span class="params">()</span> =&gt;</span> factories(app));</span><br><span class="line">afterEach(<span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">  <span class="comment">// clear database after each test case</span></span><br><span class="line">  <span class="keyword">await</span> <span class="built_in">Promise</span>.all([</span><br><span class="line">    app.model.User.destroy(&#123; <span class="attr">truncate</span>: <span class="literal">true</span>, <span class="attr">force</span>: <span class="literal">true</span> &#125;),</span><br><span class="line">  ]);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>接下来我们就可以开始编写真正的测试用例了：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// test/app/controller/users.test.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; assert, app &#125; = <span class="built_in">require</span>(<span class="string">'egg-mock/bootstrap'</span>);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'test/app/controller/users.test.js'</span>, () =&gt; &#123;</span><br><span class="line">  describe(<span class="string">'GET /users'</span>, () =&gt; &#123;</span><br><span class="line">    it(<span class="string">'should work'</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="comment">// 通过 factory-girl 快速创建 user 对象到数据库中</span></span><br><span class="line">      <span class="keyword">await</span> app.factory.createMany(<span class="string">'user'</span>, <span class="number">3</span>);</span><br><span class="line">      <span class="keyword">const</span> res = <span class="keyword">await</span> app.httpRequest().get(<span class="string">'/users?limit=2'</span>);</span><br><span class="line">      assert(res.status === <span class="number">200</span>);</span><br><span class="line">      assert(res.body.length === <span class="number">2</span>);</span><br><span class="line">      assert(res.body[<span class="number">0</span>].name);</span><br><span class="line">      assert(res.body[<span class="number">0</span>].age);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  describe(<span class="string">'GET /users/:id'</span>, () =&gt; &#123;</span><br><span class="line">    it(<span class="string">'should work'</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> user = <span class="keyword">await</span> app.factory.create(<span class="string">'user'</span>);</span><br><span class="line">      <span class="keyword">const</span> res = <span class="keyword">await</span> app.httpRequest().get(<span class="string">`/users/<span class="subst">$&#123;user.id&#125;</span>`</span>);</span><br><span class="line">      assert(res.status === <span class="number">200</span>);</span><br><span class="line">      assert(res.body.age === user.age);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  describe(<span class="string">'POST /users'</span>, () =&gt; &#123;</span><br><span class="line">    it(<span class="string">'should work'</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      app.mockCsrf();</span><br><span class="line">      <span class="keyword">let</span> res = <span class="keyword">await</span> app.httpRequest().post(<span class="string">'/users'</span>)</span><br><span class="line">        .send(&#123;</span><br><span class="line">          age: <span class="number">10</span>,</span><br><span class="line">          name: <span class="string">'name'</span>,</span><br><span class="line">        &#125;);</span><br><span class="line">      assert(res.status === <span class="number">201</span>);</span><br><span class="line">      assert(res.body.id);</span><br><span class="line"></span><br><span class="line">      res = <span class="keyword">await</span> app.httpRequest().get(<span class="string">`/users/<span class="subst">$&#123;res.body.id&#125;</span>`</span>);</span><br><span class="line">      assert(res.status === <span class="number">200</span>);</span><br><span class="line">      assert(res.body.name === <span class="string">'name'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  describe(<span class="string">'DELETE /users/:id'</span>, () =&gt; &#123;</span><br><span class="line">    it(<span class="string">'should work'</span>, <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="keyword">const</span> user = <span class="keyword">await</span> app.factory.create(<span class="string">'user'</span>);</span><br><span class="line"></span><br><span class="line">      app.mockCsrf();</span><br><span class="line">      <span class="keyword">const</span> res = <span class="keyword">await</span> app.httpRequest().delete(<span class="string">`/users/<span class="subst">$&#123;user.id&#125;</span>`</span>);</span><br><span class="line">      assert(res.status === <span class="number">200</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>最后，如果我们需要在 CI 中运行单元测试，需要确保在执行测试代码之前，执行一次 migrate 确保数据结构更新，例如我们在 <code>package.json</code> 中声明 <code>scripts.ci</code> 来在 CI 环境下执行单元测试：</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"scripts"</span>: &#123;</span><br><span class="line">    <span class="string">"ci"</span>: <span class="string">"eslint . &amp;&amp; NODE_ENV=test npx sequelize db:migrate &amp;&amp; egg-bin cov"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="完整示例"><a class="markdown-anchor" href="#完整示例">#</a> 完整示例</h2>
<p>更完整的示例可以查看 <a href="https://github.com/eggjs/examples/tree/master/sequelize" target="_blank" rel="noopener">eggjs/examples/sequelize</a>。</p>
<h2 id="脚手架"><a class="markdown-anchor" href="#脚手架">#</a> 脚手架</h2>
<p>我们也提供了 sequelize 的脚手架，集成了文档中提供的 <a href="https://github.com/eggjs/egg-sequelize" target="_blank" rel="noopener">egg-sequelize</a>, <a href="https://github.com/sequelize/cli" target="_blank" rel="noopener">sequelize-cli</a> 与 <a href="https://github.com/aexmachina/factory-girl" target="_blank" rel="noopener">factory-girl</a> 等模块。可以通过 <code>npm init egg --type=sequelize</code> 来基于它快速初始化一个新的应用。</p>
    
        </article>  
      </div>      
  </div>

  <div class="toc" id="toc">
  <ol class="toc-detail"><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#准备工作"><span class="toc-detail-number">1.</span> <span class="toc-detail-text"># 准备工作</span></a></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#初始化项目"><span class="toc-detail-number">2.</span> <span class="toc-detail-text"># 初始化项目</span></a></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#初始化数据库和-migrations"><span class="toc-detail-number">3.</span> <span class="toc-detail-text"># 初始化数据库和 Migrations</span></a></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#编写代码"><span class="toc-detail-number">4.</span> <span class="toc-detail-text"># 编写代码</span></a></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#单元测试"><span class="toc-detail-number">5.</span> <span class="toc-detail-text"># 单元测试</span></a></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#完整示例"><span class="toc-detail-number">6.</span> <span class="toc-detail-text"># 完整示例</span></a></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#脚手架"><span class="toc-detail-number">7.</span> <span class="toc-detail-text"># 脚手架</span></a></li></ol>
</div>

<script>

var tocContainer = document.getElementById('toc');
var tocDetail = document.getElementsByClassName('toc-detail')[0];

(function(){
  if(!tocDetail){
    tocContainer.style.display = 'none';
  }

  if(tocDetail){
    document.querySelectorAll('.toc-detail-text').forEach(function(element){
      element.innerText = element.innerText.replace('# ', '');
    });
  }
})();
</script>

</div>

  </div>
</body>
<script src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script>
<script>
docsearch({
  apiKey: '1561de31a86f79507ea00cdb54ce647c',
  indexName: 'eggjs',
  inputSelector: '#search-query',
});
</script>
<div class="cnzz">
<script src="https://s11.cnzz.com/z_stat.php?id=1261142226&web_id=1261142226" language="JavaScript"></script>
</div>

</html>
