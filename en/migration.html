<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <title>Egg@2 Upgrade guideline - Born to build better enterprise frameworks and apps</title>
  <meta charset="utf-8">
  <meta name="description" content="index.description">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="icon" href="/images/favicon.png" type="image/x-icon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css">
<link rel="stylesheet" href="/css/index.css">

    <script>
    !function(t,e,a,r,c){t.TracertCmdCache=t.TracertCmdCache||[],t[c]=window[c]||
      {_isInit:!0,call:function(){t.TracertCmdCache.push(arguments)},
      start:function(t){this.call('start',t)}},t[c].l=new Date;
      var n=e.createElement(a),s=e.getElementsByTagName(a)[0];
      n.async=!0,n.src=r,s.parentNode.insertBefore(n,s)}
    (window,document,'script','https://tracert.alipay.com/tracert.js','Tracert');
      Tracert.start({
        plugins: [ 'BucName' ],
        spmAPos: 'a454',
        spmBPos: 'b4893',
      });
    </script>
  
<!-- Hotjar Tracking Code for https://eggjs.org -->
<script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:1089836,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
</script>

</head>
<body>
  <div class="nav">
  <header>
    <a href="/en/" class="nav-logo leftpadding" alt="egg"><img src="https://zos.alipayobjects.com/rmsportal/VTcUYAaoKqXyHJbLAPyF.svg"></a>
    <ul class="nav-item">
      <li>
        <form id="search-form">
          <input type="text" id="search-query" class="search-query st-default-search-input">
        </form>
      </li>
      <li><a href="/en/intro/" alt="Guide">Guide</a></li><li><a href="/api/" alt="API">API</a></li><li><a href="/en/tutorials/index.html" alt="Tutorials">Tutorials</a></li><li><a href="https://github.com/search?q=topic%3Aegg-plugin&type=Repositories" alt="Plugins">Plugins</a></li><li><a href="https://github.com/eggjs/egg/releases" alt="Release">Release</a></li>
      
      
        <li class="translations">
          <a class="nav-link">Languages</a>
          <span class="arrow"></span><ul id="dropdownContent" class="dropdown-content"><li><a onclick="rememberLang('en')" id="en" href="/en/migration.html" style="color: #22ab28">English</a></li><li><a onclick="rememberLang('zh-cn')" id="zh-cn" href="/zh-cn/migration.html">中文</a></li></ul><script type="text/javascript">
    function rememberLang(lang){
      localStorage.setItem('lang', lang)
    }

    var l = localStorage.getItem('lang') || navigator.language.toLowerCase();
    var clientLanRef = {"zh-cn":"中文","en":"English"};
    var pageLang = "en"; 
    
    if(location.pathname === '/' && !!clientLanRef[l] && l !== pageLang) {
      location.href='/' + l + '/'
    }
</script>
        </li>
      
      <li><iframe src="https://ghbtns.com/github-btn.html?user=eggjs&repo=egg&type=star&count=true" frameborder="0" scrolling="0" width="150px" height="20px"></iframe></li>
    </ul>
    <a id="mobileTrigger" href="#" class="mobile-trigger">
      <ul>
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </a>
  </header>
</div>

  <div id="container" class="container">
    <div class="page-main">
  <aside id="mobileAside" class="aside">
  <div class="mobile-menu">
    <ul>
      <li><a href="/en/intro/" alt="Guide">Guide</a></li><li><a href="/api/" alt="API">API</a></li><li><a href="/en/tutorials/index.html" alt="Tutorials">Tutorials</a></li><li><a href="https://github.com/search?q=topic%3Aegg-plugin&type=Repositories" alt="Plugins">Plugins</a></li><li><a href="https://github.com/eggjs/egg/releases" alt="Release">Release</a></li>
      
      
        <li class="translations">
          <a class="nav-link">Languages</a>
          <span class="arrow"></span><ul id="dropdownContent" class="dropdown-content"><li><a onclick="rememberLang('en')" id="en" href="/en/migration.html" style="color: #22ab28">English</a></li><li><a onclick="rememberLang('zh-cn')" id="zh-cn" href="/zh-cn/migration.html">中文</a></li></ul><script type="text/javascript">
    function rememberLang(lang){
      localStorage.setItem('lang', lang)
    }

    var l = localStorage.getItem('lang') || navigator.language.toLowerCase();
    var clientLanRef = {"zh-cn":"中文","en":"English"};
    var pageLang = "en"; 
    
    if(location.pathname === '/' && !!clientLanRef[l] && l !== pageLang) {
      location.href='/' + l + '/'
    }
</script>
        </li>
      
    </ul>
  </div>
  <dl><dt id="title-Intro" style="cursor: pointer;" class="aside-title">Guide<a id="collapse-icon-Intro" class="icon opend"></a></dt><dd id="panel-Intro"><ul><li><a href="/en/intro/index.html" class="menu-link">What is Egg?</a></li><li><a href="/en/intro/egg-and-koa.html" class="menu-link">Egg and Koa</a></li><li><a href="/en/intro/quickstart.html" class="menu-link">Quick Start</a></li><li><a href="/en/tutorials/progressive.html" class="menu-link">Progressive</a></li><li><a href="/en/migration.html" class="menu-link">Migration to 2.x</a></li></ul></dd><dt id="title-Basics" style="cursor: pointer;" class="aside-title">Basis Function<a id="collapse-icon-Basics" class="icon opend"></a></dt><dd id="panel-Basics"><ul><li><a href="/en/basics/structure.html" class="menu-link">Directory Structure</a></li><li><a href="/en/basics/objects.html" class="menu-link">Built-in Objects</a></li><li><a href="/en/basics/env.html" class="menu-link">Environment</a></li><li><a href="/en/basics/config.html" class="menu-link">Configuration</a></li><li><a href="/en/basics/middleware.html" class="menu-link">Middleware</a></li><li><a href="/en/basics/router.html" class="menu-link">Router</a></li><li><a href="/en/basics/controller.html" class="menu-link">Controller</a></li><li><a href="/en/basics/service.html" class="menu-link">Service</a></li><li><a href="/en/basics/plugin.html" class="menu-link">Plugin</a></li><li><a href="/en/basics/schedule.html" class="menu-link">Schedule</a></li><li><a href="/en/basics/extend.html" class="menu-link">Extend</a></li><li><a href="/en/basics/app-start.html" class="menu-link">Custom Init</a></li></ul></dd><dt id="title-Core" style="cursor: pointer;" class="aside-title">Core<a id="collapse-icon-Core" class="icon opend"></a></dt><dd id="panel-Core"><ul><li><a href="/en/core/development.html" class="menu-link">Development</a></li><li><a href="/en/core/unittest.html" class="menu-link">Unit Testing</a></li><li><a href="/en/core/deployment.html" class="menu-link">Deployment</a></li><li><a href="/en/core/logger.html" class="menu-link">Logger</a></li><li><a href="/en/core/httpclient.html" class="menu-link">HttpClient</a></li><li><a href="/en/core/cookie-and-session.html" class="menu-link">Cookie and Session</a></li><li><a href="/en/core/cluster-and-ipc.html" class="menu-link">Cluster and IPC</a></li><li><a href="/en/core/view.html" class="menu-link">View</a></li><li><a href="/en/core/error-handling.html" class="menu-link">Error Handling</a></li><li><a href="/en/core/security.html" class="menu-link">Security</a></li><li><a href="/en/core/i18n.html" class="menu-link">i18n</a></li></ul></dd><dt id="title-Tutorials" style="cursor: pointer;" class="aside-title">Tutorials<a id="collapse-icon-Tutorials" class="icon opend"></a></dt><dd id="panel-Tutorials"><ul><li><a href="/en/tutorials/mysql.html" class="menu-link">MySQL</a></li><li><a href="/en/tutorials/sequelize.html" class="menu-link">Sequelize</a></li><li><a href="/en/tutorials/restful.html" class="menu-link">RESTful API</a></li><li><a href="/en/tutorials/passport.html" class="menu-link">Passport</a></li><li><a href="/en/tutorials/socketio.html" class="menu-link">Socket.IO</a></li><li><a href="/en/tutorials/assets.html" class="menu-link">Assets</a></li><li><a href="/en/tutorials/typescript.html" class="menu-link">TypeScript</a></li><li><a href="/en/tutorials/proxy.html" class="menu-link">Behind a Proxy</a></li></ul></dd><dt id="title-Advanced" style="cursor: pointer;" class="aside-title">Advanced<a id="collapse-icon-Advanced" class="icon opend"></a></dt><dd id="panel-Advanced"><ul><li><a href="/en/advanced/loader.html" class="menu-link">Loader</a></li><li><a href="/en/advanced/plugin.html" class="menu-link">Plugin Development</a></li><li><a href="/en/advanced/framework.html" class="menu-link">Framework</a></li><li><a href="/en/advanced/cluster-client.html" class="menu-link">Cluster Enhancement</a></li><li><a href="/en/advanced/view-plugin.html" class="menu-link">View Plugin</a></li><li><a href="/en/style-guide.html" class="menu-link">Style Guide</a></li></ul></dd><dt id="title-Community" style="cursor: pointer;" class="aside-title">Community<a id="collapse-icon-Community" class="icon opend"></a></dt><dd id="panel-Community"><ul><li><a href="/en/contributing.html" class="menu-link">Contributing</a></li><li><a href="/en/resource.html" class="menu-link">Resource</a></li><li><a href="/en/faq.html" class="menu-link">FAQ</a></li></ul></dd></dl>
</aside>
<script>
var mobileTrigger = document.getElementById('mobileTrigger');
var mobileAside = document.getElementById('mobileAside');

var expandMenu = function(title) {
  // handle icon
  const collapseIcon = document.getElementById('collapse-icon-' + title);
  if (collapseIcon) {
    collapseIcon.className = 'icon opend';
  }
  // handle panelEle
  const panelEle = document.getElementById('panel-' + title);
  if (panelEle) {
    panelEle.className = '';
  }
}

var collapseMenu = function(title) {
  // handle icon
  const collapseIcon = document.getElementById('collapse-icon-' + title);
  if (collapseIcon) {
    collapseIcon.className = 'icon closed';
  }
  // handle panelEle
  const panelEle = document.getElementById('panel-' + title);
  if (panelEle) {
    panelEle.className = 'aside-panel-hidden';
  }
}

mobileAside.onclick = function(e) {
  const targetId = e.target.id;
  if (targetId && (targetId.indexOf('title-') > -1 || targetId.indexOf('collapse-icon-') > -1)) {
    const title = targetId.replace('title-', '').replace('collapse-icon-', '');
    try {
      // the browser may have no localStorage or JSON.parse may throw exception.
      const menuInfo = JSON.parse(window.localStorage.getItem('menuInfo'));

      // current menu status
      const curClosed = menuInfo[title] ? menuInfo[title].closed : false; // default false

      // change UI
      curClosed ? expandMenu(title) : collapseMenu(title);

      // save menuInfo to localStorage
      menuInfo[title] = { closed: !curClosed } // opposite
      window.localStorage.setItem('menuInfo', JSON.stringify(menuInfo));
    } catch (e) {}
  }
};

mobileTrigger.onclick = function(e) {
  e.preventDefault();
  if (mobileAside.className.indexOf('mobile-show') === -1) {
    mobileAside.className += ' mobile-show';
  } else {
    mobileAside.className = 'aside';
  }
};

(function() {
  // save data to localStorage because the page will refresh when user change the url.
  let menuInfo;
  try {
    // the browser may have no localStorage or JSON.parse may throw exception.
    menuInfo = JSON.parse(window.localStorage.getItem('menuInfo'));
    if (!menuInfo) {
      menuInfo = {};
      window.localStorage.setItem('menuInfo', JSON.stringify(menuInfo));
    }
  } catch (e) {
    menuInfo = {}; // default {}
  }

  for (const title in menuInfo) {
    if (menuInfo[title] && menuInfo[title].closed) { // menu in closed status.
      collapseMenu(title);
    } else {
      expandMenu(title);
    }
  }

  // highlight menu
  const pathname = window.location.pathname;
  const selector = `a[href="${pathname}"].menu-link,a[href="${pathname}index.html"].menu-link`;
  const menuItem = mobileAside.querySelector(selector);
  if (menuItem) { menuItem.className += ' highlight'; }
})();
</script>


  <div class="content">
    <div class="doc">
      <article class="markdown-body">
        <h1>Egg@2 Upgrade guideline</h1>
          <h2 id="background"><a class="markdown-anchor" href="#background">#</a> Background</h2>
<p>With the official release of Node.js 8 LTS, egg now comes with built-in ES2017 Async Function support.</p>
<p>Though the TJ <a href="https://github.com/tj/co" target="_blank" rel="noopener">co</a> has brought <code>async/await</code> programming experience before this, but it also has some inevitable problems:</p>
<ul>
<li>performance lost</li>
<li><a href="https://github.com/eggjs/egg/wiki/co-vs-async" target="_blank" rel="noopener">obscure error logs</a></li>
</ul>
<p>In the official Egg 2.x:</p>
<ul>
<li>Full compatibility to Egg 1.x and <code>generator function</code>.</li>
<li>Koa 2.x based <code>async function</code> solutions.</li>
<li>Only support Node.js 8 and above.</li>
<li>Better error stack messages without <a href="https://github.com/tj/co" target="_blank" rel="noopener">co</a>, approximately 30% performance improvement (do not include the performance improvement brought by Node), see <a href="https://eggjs.github.io/benchmark/plot/" target="_blank" rel="noopener">benchmark</a> for more details.</li>
</ul>
<p>One of the Egg's concept is <code>progressive</code>, hence we provide progressive programming experiences to developers.</p>
<ul>
<li><a href="#quick_upgrade">Quick upgrade</a></li>
<li><a href="#plugin">Plugin update</a></li>
<li><a href="#forther_upgrade">Further upgrade</a></li>
<li><a href="#upgrade_documents_for_plugin_developers">Upgrade documents for Plugin developers</a></li>
</ul>
<h2 id="quick-upgrade"><a class="markdown-anchor" href="#quick-upgrade">#</a> Quick upgrade</h2>
<ul>
<li>Use the latest Node LTS version (<code>&gt;=8.9.0</code>).</li>
<li>Change <code>egg</code> version to <code>^2.0.0</code> in <code>package.json</code>.</li>
<li>Check if included plugins are the latest version (optional).</li>
<li>Reinstall the dependencies, and run unit tests again.</li>
</ul>
<p><strong>Done! Barely with any code changes</strong></p>
<h2 id="plugin-update"><a class="markdown-anchor" href="#plugin-update">#</a> Plugin update</h2>
<h3 id="egg-multipart"><a class="markdown-anchor" href="#egg-multipart">#</a> egg-multipart</h3>
<p><code>yield parts</code> needs to change to <code>await parts()</code> or <code>yield parts()</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// old</span></span><br><span class="line"><span class="keyword">const</span> parts = ctx.multipart();</span><br><span class="line"><span class="keyword">while</span> ((part = <span class="keyword">yield</span> parts) != <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="comment">// do something</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// yield parts() also work</span></span><br><span class="line"><span class="keyword">while</span> ((part = <span class="keyword">yield</span> parts()) != <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="comment">// do something</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// new</span></span><br><span class="line"><span class="keyword">const</span> parts = ctx.multipart();</span><br><span class="line"><span class="keyword">while</span> ((part = <span class="keyword">await</span> parts()) != <span class="literal">null</span>) &#123;</span><br><span class="line">  <span class="comment">// do something</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="https://github.com/eggjs/egg-multipart#upload-multiple-files" target="_blank" rel="noopener">egg-multipart#upload-multiple-files</a></li>
</ul>
<h3 id="egg-userrole"><a class="markdown-anchor" href="#egg-userrole">#</a> egg-userrole</h3>
<p>DO NOT support 1.x role definition, because koa-roles is no longer compatible.
The <code>Context</code> has changed from <code>this</code> to the first argument <code>ctx</code>, the original <code>scope</code> now is the second argument.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// old</span></span><br><span class="line">app.role.use(<span class="string">'user'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> !!<span class="keyword">this</span>.user;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// new</span></span><br><span class="line">app.role.use(<span class="function">(<span class="params">ctx, scope</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> !!ctx.user</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">app.role.use(<span class="string">'user'</span>, ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">return</span> !!ctx.user;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li><a href="https://github.com/koajs/koa-roles/pull/13" target="_blank" rel="noopener">koajs/koa-roles#13</a></li>
<li><a href="https://github.com/eggjs/egg-userrole/pull/9" target="_blank" rel="noopener">eggjs/egg-userrole#9</a></li>
</ul>
<h2 id="further-upgrade"><a class="markdown-anchor" href="#further-upgrade">#</a> Further upgrade</h2>
<p>Due to the complete compatibility to Egg 1.x, we can finish the upgrade quickly.</p>
<p>But in order to keep the coding style consistent, as well as a better performance improvement and more developer-friendly error stack logs, we suggest developers to make a further upgrade:</p>
<ul>
<li>Use recommended code style, see <a href="./style-guide.html">Style guide</a></li>
<li><a href="#use-koa2-style-middleware">Use Koa style middleware</a></li>
<li><a href="#yieldable-to-awaitable">Change <code>yieldable</code> to <code>awaitable</code> in function invoke</a></li>
</ul>
<h3 id="use-koa2-styled-middleware"><a class="markdown-anchor" href="#use-koa2-styled-middleware">#</a> Use Koa2-styled middleware</h3>
<blockquote>
<p>2.x is compatible to 1.x-styled middleware, so it's still functional without any changes.</p>
</blockquote>
<ul>
<li>Use Koa 2's <code>(ctx, next)</code> arguments style in callback function
<ul>
<li>The 1st argument is <code>ctx</code>, means context, it is an instance of <a href="./basics/extend.html#Context">Context</a></li>
<li>The 2nd argument is <code>next</code>, use await to execute it for the coming logics.</li>
</ul>
</li>
<li>Using <code>async (ctx, next) =&gt; {}</code> is not recommended, which prevents anonymous function in error stack.</li>
<li>Change <code>yield next</code> to <code>await next()</code>.</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// 1.x</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>* <span class="title">responseTime</span>(<span class="params">next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> start = <span class="built_in">Date</span>.now();</span><br><span class="line">    <span class="keyword">yield</span> next;</span><br><span class="line">    <span class="keyword">const</span> delta = <span class="built_in">Math</span>.ceil(<span class="built_in">Date</span>.now() - start);</span><br><span class="line">    <span class="keyword">this</span>.set(<span class="string">'X-Response-Time'</span>, delta + <span class="string">'ms'</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2.x</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">responseTime</span>(<span class="params">ctx, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> start = <span class="built_in">Date</span>.now();</span><br><span class="line">    <span class="comment">// Note, differ from the generator function middleware, next is a function, we're executing it here</span></span><br><span class="line">    <span class="keyword">await</span> next();</span><br><span class="line">    <span class="keyword">const</span> delta = <span class="built_in">Math</span>.ceil(<span class="built_in">Date</span>.now() - start);</span><br><span class="line">    ctx.set(<span class="string">'X-Response-Time'</span>, delta + <span class="string">'ms'</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="yieldable-to-awaitable"><a class="markdown-anchor" href="#yieldable-to-awaitable">#</a> yieldable to awaitable</h3>
<blockquote>
<p>async was supported in Egg 1.x, thus if the middleware is already async-base, we could skip this section.</p>
</blockquote>
<p><a href="https://github.com/tj/co" target="_blank" rel="noopener">co</a> supports <code>yieldable</code> compatibility types:</p>
<ul>
<li>promises</li>
<li>array (parallel execution)</li>
<li>objects (parallel execution)</li>
<li>thunks (functions)</li>
<li>generators (delegation)</li>
<li>generator functions (delegation)</li>
</ul>
<p>Despite both <code>generator</code> and <code>async</code> have the same program models, but we may still need to refactor our codes correspondingly after removing <code>co</code> because of the above special handling from <code>co</code>.</p>
<h4 id="promise"><a class="markdown-anchor" href="#promise">#</a> promise</h4>
<p>We can replace it directly:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">echo</span>(<span class="params">msg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Promise</span>.resolve(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">yield</span> echo(<span class="string">'hi egg'</span>);</span><br><span class="line"><span class="comment">// change to</span></span><br><span class="line"><span class="keyword">await</span> echo(<span class="string">'hi egg'</span>);</span><br></pre></td></tr></table></figure>
<h4 id="array-yield"><a class="markdown-anchor" href="#array-yield">#</a> array - yield []</h4>
<p><code>yeild []</code> is normally used to send concurrent requests, such as:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> [ news, user ] = <span class="keyword">yield</span> [</span><br><span class="line">  ctx.service.news.list(topic),</span><br><span class="line">  ctx.service.user.get(uid),</span><br><span class="line">];</span><br></pre></td></tr></table></figure>
<p>In this case, use <code>Promise.all()</code> to wrap it:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> [ news, user ] = <span class="keyword">await</span> <span class="built_in">Promise</span>.all([</span><br><span class="line">  ctx.service.news.list(topic),</span><br><span class="line">  ctx.service.user.get(uid),</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
<h4 id="object-yield"><a class="markdown-anchor" href="#object-yield">#</a> object - yield {}</h4>
<p>Sometimes <code>yield {}</code> and <code>yield map</code> can also be used to send concurrent requests, but it may be a bit complex in this place because <code>Promise.all</code> doesn't support Object argument.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/service/biz.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BizService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">  * list(topic, uid) &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      news: ctx.service.news.list(topic),</span><br><span class="line">      user: ctx.service.user.get(uid),</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app/controller/home.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; news, user &#125; = <span class="keyword">yield</span> ctx.service.biz.list(topic, uid);</span><br></pre></td></tr></table></figure>
<p>It's recommended to use <code>await Promise.all([])</code>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/service/biz.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BizService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">  list(topic, uid) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Promise</span>.all([</span><br><span class="line">      ctx.service.news.list(topic),</span><br><span class="line">      ctx.service.user.get(uid),</span><br><span class="line">    ]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app/controller/home.js</span></span><br><span class="line"><span class="keyword">const</span> [ news, user ] = <span class="keyword">await</span> ctx.service.biz.list(topic, uid);</span><br></pre></td></tr></table></figure>
<p>If the interfaces are unchangeable, e can do things below as a workaround:</p>
<ul>
<li>Use <a href="https://github.com/eggjs/egg-core/blob/da4ba1784175c43217125f3d5cd7f0be3d5396bf/lib/egg.js#L353" target="_blank" rel="noopener">app.toPromise</a> method provided by our Utils.</li>
<li><strong>This is built on top of the <a href="https://github.com/tj/co" target="_blank" rel="noopener">co</a>, so it may still cause performance issue and returning inaccurate error stacks, so this is not recommended.</strong></li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; news, user &#125; = <span class="keyword">await</span> app.toPromise(ctx.service.biz.list(topic, uid));</span><br></pre></td></tr></table></figure>
<h4 id="others"><a class="markdown-anchor" href="#others">#</a> Others</h4>
<ul>
<li>thunks (functions)</li>
<li>generators (delegation)</li>
<li>generator functions (delegation)</li>
</ul>
<p>Use <code>async function</code> to replace the above functions, or use <a href="https://github.com/eggjs/egg-core/blob/da4ba1784175c43217125f3d5cd7f0be3d5396bf/lib/egg.js#L344" target="_blank" rel="noopener">app.toAsyncFunction</a> alternatively.</p>
<p><strong>Note</strong></p>
<ul>
<li><a href="https://github.com/eggjs/egg-core/blob/da4ba1784175c43217125f3d5cd7f0be3d5396bf/lib/egg.js#L344" target="_blank" rel="noopener">toAsyncFunction</a> and <a href="https://github.com/eggjs/egg-core/blob/da4ba1784175c43217125f3d5cd7f0be3d5396bf/lib/egg.js#L353" target="_blank" rel="noopener">toPromise</a> are wrappers of <a href="https://github.com/tj/co" target="_blank" rel="noopener">co</a>, thus it may cause performance lost and error stack problems. So we're recommending developers to use all-chain upgrade.</li>
<li><a href="https://github.com/eggjs/egg-core/blob/da4ba1784175c43217125f3d5cd7f0be3d5396bf/lib/egg.js#L344" target="_blank" rel="noopener">toAsyncFunction</a> doesn't have performance lost when invokes async function.</li>
</ul>
<p>@sindresorhus has written a lot <a href="https://github.com/sindresorhus/promise-fun" target="_blank" rel="noopener">promise-based helpers</a>, use them together with async function could make source code more readable.</p>
<h2 id="plugin-update-2"><a class="markdown-anchor" href="#plugin-update-2">#</a> Plugin update</h2>
<p><code>App developers</code> just need to update the upgraded plugins by <code>plugin developers</code>, or use <code>egg-bin autod</code> command we've prepared to quickly update.</p>
<p>The following content is for <code>plugin developers</code>, it shows how to update the plugins:</p>
<h3 id="update-precautions"><a class="markdown-anchor" href="#update-precautions">#</a> Update precautions</h3>
<ul>
<li>Finish the upgrade items above.
<ul>
<li>Replace all <code>generator function</code> with <code>async function</code>.</li>
<li>Upgrade middlewares.</li>
</ul>
</li>
<li>Interfaces compatibility (optional), see following.</li>
<li>Release a major version.</li>
</ul>
<h3 id="interfaces-compatibility"><a class="markdown-anchor" href="#interfaces-compatibility">#</a> Interfaces compatibility</h3>
<p>In some cases, the interface provided by <code>Plugin developers</code> supports both generator and async, normally it's wrapped by co.</p>
<ul>
<li>In 2.x, we suggest <code>async-first</code> to get a better performance and clearer error stacks.</li>
<li>If necessary, please use <a href="https://github.com/eggjs/egg-core/blob/da4ba1784175c43217125f3d5cd7f0be3d5396bf/lib/egg.js#L344" target="_blank" rel="noopener">toAsyncFunction</a> and <a href="https://github.com/eggjs/egg-core/blob/da4ba1784175c43217125f3d5cd7f0be3d5396bf/lib/egg.js#L353" target="_blank" rel="noopener">toPromise</a> for compatibility.</li>
</ul>
<p>Like <a href="https://github.com/eggjs/egg-schedule" target="_blank" rel="noopener">egg-schedule</a> plugin, it supports generator or async to define the tasks in application level.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// &#123;app_root&#125;/app/schedule/cleandb.js</span></span><br><span class="line">exports.task = <span class="function"><span class="keyword">function</span>* (<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">yield</span> ctx.service.db.clean();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;app_root&#125;/app/schedule/log.js</span></span><br><span class="line">exports.task = <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">splitLog</span>(<span class="params">ctx</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">await</span> ctx.service.log.split();</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>Plugin developers</code> could simply wrap the following raw function:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// https://github.com/eggjs/egg-schedule/blob/80252ef/lib/load_schedule.js#L38</span></span><br><span class="line">task = app.toAsyncFunction(schedule.task);</span><br></pre></td></tr></table></figure>
<h3 id="rules-of-plugin-release"><a class="markdown-anchor" href="#rules-of-plugin-release">#</a> Rules of Plugin release</h3>
<ul>
<li><strong>Major version releasement</strong>
<ul>
<li>All the APIs are promise based, and there's no <code>async</code> in source code. e.g. <a href="https://github.com/eggjs/egg-view-nunjucks" target="_blank" rel="noopener">egg-view-nunjucks</a></li>
</ul>
</li>
<li>Modify <code>package.json</code>
<ul>
<li>Change <code>egg</code> in <code>devDependencies</code> to <code>^2.0.0</code>.</li>
<li>Change <code>engines.node</code> to <code>&gt;=8.0.0</code>.</li>
<li>Change <code>ci.version</code> to <code>8, 9</code>, reinstall dependencies to generate new travis config files.</li>
</ul>
</li>
<li>Update examples in <code>README.md</code> with async function.</li>
<li>Write instructions for upgrade.</li>
<li>(optional) Change <code>test/fixtures</code> to async function, and it's recommended to create a PR for code preview.</li>
</ul>
<p>In case the previous versions still requires maintenance:</p>
<ul>
<li>Create a new branch which based on previous <code>1.x</code> version.</li>
<li>Change the <code>publishConfig.tag</code> property in <code>package.json</code> to <code>release-1.x</code> in previous version.</li>
<li>If the previous version has new Bugfix, tag it as <code>release-1.x</code> when publishing, so users may use <code>npm i egg-xx@release-1</code> to import the old version.</li>
<li>See <a href="https://docs.npmjs.com/cli/dist-tag" target="_blank" rel="noopener">npm documentations</a>.</li>
</ul>
    
        </article>  
      </div>      
  </div>

  <div class="toc" id="toc">
  <ol class="toc-detail"><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#background"><span class="toc-detail-number">1.</span> <span class="toc-detail-text"># Background</span></a></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#quick-upgrade"><span class="toc-detail-number">2.</span> <span class="toc-detail-text"># Quick upgrade</span></a></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#plugin-update"><span class="toc-detail-number">3.</span> <span class="toc-detail-text"># Plugin update</span></a><ol class="toc-detail-child"><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#egg-multipart"><span class="toc-detail-number">3.1.</span> <span class="toc-detail-text"># egg-multipart</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#egg-userrole"><span class="toc-detail-number">3.2.</span> <span class="toc-detail-text"># egg-userrole</span></a></li></ol></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#further-upgrade"><span class="toc-detail-number">4.</span> <span class="toc-detail-text"># Further upgrade</span></a><ol class="toc-detail-child"><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#use-koa2-styled-middleware"><span class="toc-detail-number">4.1.</span> <span class="toc-detail-text"># Use Koa2-styled middleware</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#yieldable-to-awaitable"><span class="toc-detail-number">4.2.</span> <span class="toc-detail-text"># yieldable to awaitable</span></a></li></ol></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#plugin-update-2"><span class="toc-detail-number">5.</span> <span class="toc-detail-text"># Plugin update</span></a><ol class="toc-detail-child"><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#update-precautions"><span class="toc-detail-number">5.1.</span> <span class="toc-detail-text"># Update precautions</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#interfaces-compatibility"><span class="toc-detail-number">5.2.</span> <span class="toc-detail-text"># Interfaces compatibility</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#rules-of-plugin-release"><span class="toc-detail-number">5.3.</span> <span class="toc-detail-text"># Rules of Plugin release</span></a></li></ol></li></ol>
</div>

<script>

var tocContainer = document.getElementById('toc');
var tocDetail = document.getElementsByClassName('toc-detail')[0];

(function(){
  if(!tocDetail){
    tocContainer.style.display = 'none';
  }

  if(tocDetail){
    document.querySelectorAll('.toc-detail-text').forEach(function(element){
      element.innerText = element.innerText.replace('# ', '');
    });
  }
})();
</script>

</div>

  </div>
</body>
<script src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script>
<script>
docsearch({
  apiKey: '1561de31a86f79507ea00cdb54ce647c',
  indexName: 'eggjs',
  inputSelector: '#search-query',
});
</script>
<div class="cnzz">
<script src="https://s11.cnzz.com/z_stat.php?id=1261142226&web_id=1261142226" language="JavaScript"></script>
</div>

</html>
