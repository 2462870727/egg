<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <title>Controller - Born to build better enterprise frameworks and apps</title>
  <meta charset="utf-8">
  <meta name="description" content="index.description">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="icon" href="/images/favicon.png" type="image/x-icon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css">
<link rel="stylesheet" href="/css/index.css">

    <script>
    !function(t,e,a,r,c){t.TracertCmdCache=t.TracertCmdCache||[],t[c]=window[c]||
      {_isInit:!0,call:function(){t.TracertCmdCache.push(arguments)},
      start:function(t){this.call('start',t)}},t[c].l=new Date;
      var n=e.createElement(a),s=e.getElementsByTagName(a)[0];
      n.async=!0,n.src=r,s.parentNode.insertBefore(n,s)}
    (window,document,'script','https://tracert.alipay.com/tracert.js','Tracert');
      Tracert.start({
        plugins: [ 'BucName' ],
        spmAPos: 'a454',
        spmBPos: 'b4893',
      });
    </script>
  
<!-- Hotjar Tracking Code for https://eggjs.org -->
<script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:1089836,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
</script>

</head>
<body>
  <div class="nav">
  <header>
    <a href="/en/" class="nav-logo leftpadding" alt="egg"><img src="https://zos.alipayobjects.com/rmsportal/VTcUYAaoKqXyHJbLAPyF.svg"></a>
    <ul class="nav-item">
      <li>
        <form id="search-form">
          <input type="text" id="search-query" class="search-query st-default-search-input">
        </form>
      </li>
      <li><a href="/en/intro/" alt="Guide">Guide</a></li><li><a href="/api/" alt="API">API</a></li><li><a href="/en/tutorials/index.html" alt="Tutorials">Tutorials</a></li><li><a href="https://github.com/search?q=topic%3Aegg-plugin&type=Repositories" alt="Plugins">Plugins</a></li><li><a href="https://github.com/eggjs/egg/releases" alt="Release">Release</a></li>
      
      
        <li class="translations">
          <a class="nav-link">Languages</a>
          <span class="arrow"></span><ul id="dropdownContent" class="dropdown-content"><li><a id="en" href="/en/basics/controller.html" style="color: #22ab28">English</a></li><li><a id="zh-cn" href="/zh-cn/basics/controller.html">中文</a></li></ul>
        </li>
      
      <li><iframe src="https://ghbtns.com/github-btn.html?user=eggjs&repo=egg&type=star&count=true" frameborder="0" scrolling="0" width="150px" height="20px"></iframe></li>
    </ul>
    <a id="mobileTrigger" href="#" class="mobile-trigger">
      <ul>
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </a>
  </header>
</div>

  <div id="container" class="container">
    <div class="page-main">
  <aside id="mobileAside" class="aside">
  <div class="mobile-menu">
    <ul>
      <li><a href="/en/intro/" alt="Guide">Guide</a></li><li><a href="/api/" alt="API">API</a></li><li><a href="/en/tutorials/index.html" alt="Tutorials">Tutorials</a></li><li><a href="https://github.com/search?q=topic%3Aegg-plugin&type=Repositories" alt="Plugins">Plugins</a></li><li><a href="https://github.com/eggjs/egg/releases" alt="Release">Release</a></li>
      
      
        <li class="translations">
          <a class="nav-link">Languages</a>
          <span class="arrow"></span><ul id="dropdownContent" class="dropdown-content"><li><a id="en" href="/en/basics/controller.html" style="color: #22ab28">English</a></li><li><a id="zh-cn" href="/zh-cn/basics/controller.html">中文</a></li></ul>
        </li>
      
    </ul>
  </div>
  <dl><dt id="title-Intro" style="cursor: pointer;" class="aside-title">Guide<a id="collapse-icon-Intro" class="icon opend"></a></dt><dd id="panel-Intro"><ul><li><a href="/en/intro/index.html" class="menu-link">What is Egg?</a></li><li><a href="/en/intro/egg-and-koa.html" class="menu-link">Egg and Koa</a></li><li><a href="/en/intro/quickstart.html" class="menu-link">Quick Start</a></li><li><a href="/en/tutorials/progressive.html" class="menu-link">Progressive</a></li><li><a href="/en/migration.html" class="menu-link">Migration to 2.x</a></li></ul></dd><dt id="title-Basics" style="cursor: pointer;" class="aside-title">Basis Function<a id="collapse-icon-Basics" class="icon opend"></a></dt><dd id="panel-Basics"><ul><li><a href="/en/basics/structure.html" class="menu-link">Directory Structure</a></li><li><a href="/en/basics/objects.html" class="menu-link">Built-in Objects</a></li><li><a href="/en/basics/env.html" class="menu-link">Environment</a></li><li><a href="/en/basics/config.html" class="menu-link">Configuration</a></li><li><a href="/en/basics/middleware.html" class="menu-link">Middleware</a></li><li><a href="/en/basics/router.html" class="menu-link">Router</a></li><li><a href="/en/basics/controller.html" class="menu-link">Controller</a></li><li><a href="/en/basics/service.html" class="menu-link">Service</a></li><li><a href="/en/basics/plugin.html" class="menu-link">Plugin</a></li><li><a href="/en/basics/schedule.html" class="menu-link">Schedule</a></li><li><a href="/en/basics/extend.html" class="menu-link">Extend</a></li><li><a href="/en/basics/app-start.html" class="menu-link">Custom Init</a></li></ul></dd><dt id="title-Core" style="cursor: pointer;" class="aside-title">Core<a id="collapse-icon-Core" class="icon opend"></a></dt><dd id="panel-Core"><ul><li><a href="/en/core/development.html" class="menu-link">Development</a></li><li><a href="/en/core/unittest.html" class="menu-link">Unit Testing</a></li><li><a href="/en/core/deployment.html" class="menu-link">Deployment</a></li><li><a href="/en/core/logger.html" class="menu-link">Logger</a></li><li><a href="/en/core/httpclient.html" class="menu-link">HttpClient</a></li><li><a href="/en/core/cookie-and-session.html" class="menu-link">Cookie and Session</a></li><li><a href="/en/core/cluster-and-ipc.html" class="menu-link">Cluster and IPC</a></li><li><a href="/en/core/view.html" class="menu-link">View</a></li><li><a href="/en/core/error-handling.html" class="menu-link">Error Handling</a></li><li><a href="/en/core/security.html" class="menu-link">Security</a></li><li><a href="/en/core/i18n.html" class="menu-link">i18n</a></li></ul></dd><dt id="title-Tutorials" style="cursor: pointer;" class="aside-title">Tutorials<a id="collapse-icon-Tutorials" class="icon opend"></a></dt><dd id="panel-Tutorials"><ul><li><a href="/en/tutorials/mysql.html" class="menu-link">MySQL</a></li><li><a href="/en/tutorials/sequelize.html" class="menu-link">Sequelize</a></li><li><a href="/en/tutorials/restful.html" class="menu-link">RESTful API</a></li><li><a href="/en/tutorials/passport.html" class="menu-link">Passport</a></li><li><a href="/en/tutorials/socketio.html" class="menu-link">Socket.IO</a></li><li><a href="/en/tutorials/assets.html" class="menu-link">Assets</a></li><li><a href="/en/tutorials/typescript.html" class="menu-link">TypeScript</a></li><li><a href="/en/tutorials/proxy.html" class="menu-link">Behind a Proxy</a></li></ul></dd><dt id="title-Advanced" style="cursor: pointer;" class="aside-title">Advanced<a id="collapse-icon-Advanced" class="icon opend"></a></dt><dd id="panel-Advanced"><ul><li><a href="/en/advanced/loader.html" class="menu-link">Loader</a></li><li><a href="/en/advanced/plugin.html" class="menu-link">Plugin Development</a></li><li><a href="/en/advanced/framework.html" class="menu-link">Framework</a></li><li><a href="/en/advanced/cluster-client.html" class="menu-link">Cluster Enhancement</a></li><li><a href="/en/advanced/view-plugin.html" class="menu-link">View Plugin</a></li><li><a href="/en/style-guide.html" class="menu-link">Style Guide</a></li></ul></dd><dt id="title-Community" style="cursor: pointer;" class="aside-title">Community<a id="collapse-icon-Community" class="icon opend"></a></dt><dd id="panel-Community"><ul><li><a href="/en/contributing.html" class="menu-link">Contributing</a></li><li><a href="/en/resource.html" class="menu-link">Resource</a></li><li><a href="/en/faq.html" class="menu-link">FAQ</a></li></ul></dd></dl>
</aside>
<script>
var mobileTrigger = document.getElementById('mobileTrigger');
var mobileAside = document.getElementById('mobileAside');

var expandMenu = function(title) {
  // handle icon
  const collapseIcon = document.getElementById('collapse-icon-' + title);
  if (collapseIcon) {
    collapseIcon.className = 'icon opend';
  }
  // handle panelEle
  const panelEle = document.getElementById('panel-' + title);
  if (panelEle) {
    panelEle.className = '';
  }
}

var collapseMenu = function(title) {
  // handle icon
  const collapseIcon = document.getElementById('collapse-icon-' + title);
  if (collapseIcon) {
    collapseIcon.className = 'icon closed';
  }
  // handle panelEle
  const panelEle = document.getElementById('panel-' + title);
  if (panelEle) {
    panelEle.className = 'aside-panel-hidden';
  }
}

mobileAside.onclick = function(e) {
  const targetId = e.target.id;
  if (targetId && (targetId.indexOf('title-') > -1 || targetId.indexOf('collapse-icon-') > -1)) {
    const title = targetId.replace('title-', '').replace('collapse-icon-', '');
    try { 
      // the the browser may have no localStroage or JSON.parse may throw exception.
      const menuInfo = JSON.parse(window.localStorage.getItem('menuInfo'));
        
      // current menu status
      const curClosed = menuInfo[title] ? menuInfo[title].closed : false; // default false

      // change UI
      curClosed ? expandMenu(title) : collapseMenu(title);

      // save menuInfo to localStorage
      menuInfo[title] = { closed: !curClosed } // opposite
      window.localStorage.setItem('menuInfo', JSON.stringify(menuInfo));
    } catch (e) {}
  }
};

mobileTrigger.onclick = function(e) {
  e.preventDefault();
  if (mobileAside.className.indexOf('mobile-show') === -1) {
    mobileAside.className += ' mobile-show';
  } else {
    mobileAside.className = 'aside';
  }
};

(function() {
  // save data to localStorage because the page will refresh when user change the url.
  let menuInfo;
  try { 
    // the the browser may have no localStroage or JSON.parse may throw exception.
    menuInfo = JSON.parse(window.localStorage.getItem('menuInfo'));
    if (!menuInfo) {
      menuInfo = {};
      window.localStorage.setItem('menuInfo', JSON.stringify(menuInfo));
    }
  } catch (e) {
    menuInfo = {}; // default {}
  }

  for (const title in menuInfo) {
    if (menuInfo[title] && menuInfo[title].closed) { // menu in closed status.
      collapseMenu(title);
    } else {
      expandMenu(title);
    }
  }

  // highlight menu
  const pathname = window.location.pathname;
  const selector = `a[href="${pathname}"].menu-link,a[href="${pathname}index.html"].menu-link`;
  const menuItem = mobileAside.querySelector(selector);
  if (menuItem) { menuItem.className += ' highlight'; }
})();
</script>


  <div class="content">
    <div class="doc">
      <article class="markdown-body">
        <h1>Controller</h1>
          <h2 id="what-is-controller"><a class="markdown-anchor" href="#what-is-controller">#</a> What is Controller</h2>
<p><a href="./router.html">The previous chapter</a> says router is mainly used to describe the relationship between the request URL and the Controller that processes the request eventually, so what is a Controller used for?</p>
<p>Simply speaking, a Controller is used for <strong>parsing user's input and send back the relative result after processing</strong>, for example:</p>
<ul>
<li>In <a href="https://en.wikipedia.org/wiki/Representational_state_transfer" target="_blank" rel="noopener">RESTful</a> interfaces, Controller accepts parameters from users and sends selected results back to user or modifies data in the database.</li>
<li>In the HTML page requests, Controller renders related templates to HTML according to different URLs requested and then sends back to users.</li>
<li>In the proxy servers, Controller transfers user's requests to other servers and sends back process results to users in return.</li>
</ul>
<p>The framework recommends that the Controller layer is responsible for processing request parameters(verification and transformation) from user's requests, then calls related business methods in <a href="./service.html">Service</a>, encapsulates and sends back business result:</p>
<ol>
<li>retrieves parameters passed by HTTP.</li>
<li>verifies and assembles parameters.</li>
<li>calls the Service to handle business, if necessary, transforms Service process results to satisfy user's requirement.</li>
<li>sends results back to user by HTTP.</li>
</ol>
<h2 id="how-to-write-controller"><a class="markdown-anchor" href="#how-to-write-controller">#</a> How To Write Controller</h2>
<p>All Controller files must be put under <code>app/controller</code> directory, which can support multi-level directory. when accessing, cascading access can be done through directory names. Controllers can be written in various patterns depending on various project scenarios and development styles.</p>
<h3 id="controller-classrecommended"><a class="markdown-anchor" href="#controller-classrecommended">#</a> Controller Class(Recommended)</h3>
<p>You can write a Controller by defining a Controller class:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/controller/post.js</span></span><br><span class="line"><span class="keyword">const</span> Controller = <span class="built_in">require</span>(<span class="string">'egg'</span>).Controller;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> create() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx, service &#125; = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">const</span> createRule = &#123;</span><br><span class="line">      title: &#123; <span class="attr">type</span>: <span class="string">'string'</span> &#125;,</span><br><span class="line">      content: &#123; <span class="attr">type</span>: <span class="string">'string'</span> &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// verify parameters</span></span><br><span class="line">    ctx.validate(createRule);</span><br><span class="line">    <span class="comment">// assemble parameters</span></span><br><span class="line">    <span class="keyword">const</span> author = ctx.session.userId;</span><br><span class="line">    <span class="keyword">const</span> req = <span class="built_in">Object</span>.assign(ctx.request.body, &#123; author &#125;);</span><br><span class="line">    <span class="comment">// calls Service to handle business</span></span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> service.post.create(req);</span><br><span class="line">    <span class="comment">// set response content and status code</span></span><br><span class="line">    ctx.body = &#123; <span class="attr">id</span>: res.id &#125;;</span><br><span class="line">    ctx.status = <span class="number">201</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = PostController;</span><br></pre></td></tr></table></figure>
<p>We've defined a <code>PostController</code> class above and every method of this Controller can be used in Router, we can locate it from <code>app.controller</code> according to the file name and the method name.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/router.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; router, controller &#125; = app;</span><br><span class="line">  router.post(<span class="string">'createPost'</span>, <span class="string">'/api/posts'</span>, controller.post.create);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Multi-level directory is supported, for example, put the above code into <code>app/controller/sub/post.js</code>, then we could mount it by:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/router.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">  app.router.post(<span class="string">'createPost'</span>, <span class="string">'/api/posts'</span>, app.controller.sub.post.create);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The defined Controller class will initialize a new object for every request when accessing the server, and some of the following attributes will be attached to <code>this</code> since the Controller classes in the project are inherited from <code>egg.Controller</code>.</p>
<ul>
<li><code>this.ctx</code>: the instance of <a href="./extend.html#context">Context</a> for current request, through which we can access many attributes and methods encapsulated by the framework to handle current request conveniently.</li>
<li><code>this.app</code>: the instance of <a href="./extend.html#application">Application</a> for current request, through which we can access global objects and methods provided by the framework.</li>
<li><code>this.service</code>: <a href="./service.html">Service</a> defined by the application, through which we can access the abstract business layer, equivalent to <code>this.ctx.service</code>.</li>
<li><code>this.config</code>: the application's run-time <a href="./config.html">config</a>.</li>
<li><code>this.logger</code>：logger with <code>debug</code>，<code>info</code>，<code>warn</code>，<code>error</code>, use to print different level log, is almost the same as <a href="../core/logger.html#context-logger">context logger</a>, but it will append Controller file path for quickly track.</li>
</ul>
<h4 id="customized-controller-base-class"><a class="markdown-anchor" href="#customized-controller-base-class">#</a> Customized Controller Base Class</h4>
<p>Defining a Controller class helps us not only abstract the Controller layer codes better(e.g. some unified processing can be abstracted as private) but also encapsulate methods that are widely used in the application by defining a customized Controller base class.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/core/base_controller.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; Controller &#125; = <span class="built_in">require</span>(<span class="string">'egg'</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BaseController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">get</span> user() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.ctx.session.user;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  success(data) &#123;</span><br><span class="line">    <span class="keyword">this</span>.ctx.body = &#123;</span><br><span class="line">      success: <span class="literal">true</span>,</span><br><span class="line">      data,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  notFound(msg) &#123;</span><br><span class="line">    msg = msg || <span class="string">'not found'</span>;</span><br><span class="line">    <span class="keyword">this</span>.ctx.throw(<span class="number">404</span>, msg);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = BaseController;</span><br></pre></td></tr></table></figure>
<p>Now we can use base class' methods by inheriting from <code>BaseController</code>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//app/controller/post.js</span></span><br><span class="line"><span class="keyword">const</span> Controller = <span class="built_in">require</span>(<span class="string">'../core/base_controller'</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> list() &#123;</span><br><span class="line">    <span class="keyword">const</span> posts = <span class="keyword">await</span> <span class="keyword">this</span>.service.listByUser(<span class="keyword">this</span>.user);</span><br><span class="line">    <span class="keyword">this</span>.success(posts);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="methods-style-controller-its-not-recommended-only-for-compatibility"><a class="markdown-anchor" href="#methods-style-controller-its-not-recommended-only-for-compatibility">#</a> Methods Style Controller (It's not recommended, only for compatibility)</h3>
<p>Every Controller is an async function, whose argument is the instance of the request <a href="./extend.html#context">Context</a> and through which we can access many attributes and methods encapsulated by the framework conveniently.</p>
<p>For example, when we define a Controller relative to <code>POST /api/posts</code>, we create a <code>post.js</code> file under <code>app/controller</code> directory.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/controller/post.js</span></span><br><span class="line">exports.create = <span class="keyword">async</span> ctx =&gt; &#123;</span><br><span class="line">  <span class="keyword">const</span> createRule = &#123;</span><br><span class="line">    title: &#123; <span class="attr">type</span>: <span class="string">'string'</span> &#125;,</span><br><span class="line">    content: &#123; <span class="attr">type</span>: <span class="string">'string'</span> &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// verify parameters</span></span><br><span class="line">  ctx.validate(createRule);</span><br><span class="line">  <span class="comment">// assemble parameters</span></span><br><span class="line">  <span class="keyword">const</span> author = ctx.session.userId;</span><br><span class="line">  <span class="keyword">const</span> req = <span class="built_in">Object</span>.assign(ctx.request.body, &#123; author &#125;);</span><br><span class="line">  <span class="comment">// calls Service to handle business</span></span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">await</span> ctx.service.post.create(req);</span><br><span class="line">  <span class="comment">// set response content and status code</span></span><br><span class="line">  ctx.body = &#123; <span class="attr">id</span>: res.id &#125;;</span><br><span class="line">  ctx.status = <span class="number">201</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>In the above example, we introduce some new concepts, however it's still intuitive and understandable. We'll explain these new concepts in detail soon.</p>
<h2 id="http-basics"><a class="markdown-anchor" href="#http-basics">#</a> HTTP Basics</h2>
<p>Since Controller is probably the only place to interact with HTTP protocol when developing business logics, it's necessary to have a quick look at how HTTP protocol works before going on.</p>
<p>If we send a HTTP request to access the previous example Controller:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">curl -X POST http://localhost:3000/api/posts --data &apos;&#123;&quot;title&quot;:&quot;controller&quot;, &quot;content&quot;: &quot;what is controller&quot;&#125;&apos; --header &apos;Content-Type:application/json; charset=UTF-8&apos;</span><br></pre></td></tr></table></figure>
<p>The HTTP request sent by curl looks like this:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">POST /api/posts HTTP/1.1</span><br><span class="line">Host: localhost:3000</span><br><span class="line">Content-Type: application/json; charset=UTF-8</span><br><span class="line"></span><br><span class="line">&#123;&quot;title&quot;: &quot;controller&quot;, &quot;content&quot;: &quot;what is controller&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>The first line of the request contains three information, first two of which are commonly used:</p>
<ul>
<li>method: it's <code>POST</code> in this example.</li>
<li>path: it's <code>/api/posts</code>, if the user's request contains query, it will also be placed here.</li>
</ul>
<p>From the second line to the place where the first empty line appears is the Header part of the request which includes many useful attributes. as you may see, Host, Content-Type and <code>Cookie</code>, <code>User-Agent</code>, etc. There are two headers in this request:</p>
<ul>
<li><code>Host</code>: when we send a request in the browser, the domain is resolved to server IP by DNS and, as well, the domain and port are sent to the server in the Host header by the browser.</li>
<li><code>Content-Type</code>: when we have a body in our request, the Content-Type is provided to describe the type of our request body.</li>
</ul>
<p>The whole following content is the request body, which can be brought by POST, PUT, DELETE and other methods. and the server resolves the request body according to Content-Type.</p>
<p>When the sever finishes to process the request, a HTTP response is sent back to the client:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">HTTP/1.1 201 Created</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">Content-Length: 8</span><br><span class="line">Date: Mon, 09 Jan 2017 08:40:28 GMT</span><br><span class="line">Connection: keep-alive</span><br><span class="line"></span><br><span class="line">&#123;&quot;id&quot;: 1&#125;</span><br></pre></td></tr></table></figure>
<p>The first line contains three segments, among which the <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes" target="_blank" rel="noopener">status code</a> is used mostly, in this case, it's 201 which means the server has created a resource successfully.</p>
<p>Similar to the request, the header part begins at the second line and ends at the place where the next empty line appears, in this case, they are Content-Type and Content-Length indicating the response format is JSON and the length is 8 bytes.</p>
<p>The remaining part is the actual content of this response.</p>
<h2 id="acquire-http-request-parameters"><a class="markdown-anchor" href="#acquire-http-request-parameters">#</a> Acquire HTTP Request Parameters</h2>
<p>It can be seen from the above HTTP request examples that there are many places can be used to put user's request data. The framework provides many convenient methods and attributes by binding the Context instance to Controllers to acquire parameters sent by users through HTTP request.</p>
<h3 id="query"><a class="markdown-anchor" href="#query">#</a> <code>query</code></h3>
<p>Usually the Query String, string following <code>?</code> in the URL, is used to send parameters by request of GET type. For example, <code>category=egg&amp;language=node</code> in <code>GET /posts?category=egg&amp;language=node</code> is the parameter that user sends. We can acquire this parsed parameter body through <code>ctx.query</code>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> listPosts() &#123;</span><br><span class="line">    <span class="keyword">const</span> query = <span class="keyword">this</span>.ctx.query;</span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//   category: 'egg',</span></span><br><span class="line">    <span class="comment">//   language: 'node',</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>If duplicated keys exist in Query String, only the first value of this key is used by <code>ctx.query</code> and the subsequent appearance will be omitted. That is to say, for request <code>GET /posts?category=egg&amp;category=koa</code>, what <code>ctx.query</code> acquires is <code>{ category: 'egg' }</code>.</p>
<p>This is for unity reason, because we usually do not design users to pass parameters with same keys in Query String then we write codes like below:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> key = ctx.query.key || <span class="string">''</span>;</span><br><span class="line"><span class="keyword">if</span> (key.startsWith(<span class="string">'egg'</span>)) &#123;</span><br><span class="line">  <span class="comment">// do something</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Or if someone passes parameters with same keys in Query String on purpose, system error may be thrown. To avoid this, the framework guarantee that the parameter must be a string type whenever it is acquired from <code>ctx.query</code>.</p>
<h4 id="queries"><a class="markdown-anchor" href="#queries">#</a> <code>queries</code></h4>
<p>Sometimes our system is designed to accept same keys sent by users, like <code>GET /posts?category=egg&amp;id=1&amp;id=2&amp;id=3</code>. For this situation, the framework provides <code>ctx.queries</code> object to parse Query String and put duplicated data into an array:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// GET /posts?category=egg&amp;id=1&amp;id=2&amp;id=3</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> listPosts() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="keyword">this</span>.ctx.queries);</span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//   category: [ 'egg' ],</span></span><br><span class="line">    <span class="comment">//   id: [ '1', '2', '3' ],</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>All key on the <code>ctx.queries</code> will be an array type if it has a value.</p>
<h3 id="router-params"><a class="markdown-anchor" href="#router-params">#</a> Router Params</h3>
<p>In <a href="./router.html">Router</a> part, we say Router is allowed to declare parameters which can be acquired by <code>ctx.params</code>.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app.get('/projects/:projectId/app/:appId', 'app.listApp');</span></span><br><span class="line"><span class="comment">// GET /projects/1/app/2</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> listApp() &#123;</span><br><span class="line">    assert.equal(<span class="keyword">this</span>.ctx.params.projectId, <span class="string">'1'</span>);</span><br><span class="line">    assert.equal(<span class="keyword">this</span>.ctx.params.appId, <span class="string">'2'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="body"><a class="markdown-anchor" href="#body">#</a> <code>body</code></h3>
<p>Although we can pass parameters through URL, but constraints exist:</p>
<ul>
<li><a href="http://stackoverflow.com/questions/417142/what-is-the-maximum-length-of-a-url-in-different-browsers" target="_blank" rel="noopener">the browser limits the maximum length of a URL</a>, so too many parameters cannot be passed.</li>
<li>the server records the full request URL to log files so it is not safe to pass sensitive data through URL.</li>
</ul>
<p>In the above HTTP request message example, we can learn, following the header, there's a body part that can be used to put parameters for POST, PUT and DELETE, etc. The <code>Content-Type</code> will be sent by clients(browser) in the same time to tell the server the type of request body when there is a body in a general request. Two mostly used data formats are JSON and Form in Web developing for transferring data.</p>
<p>The <a href="https://github.com/koajs/bodyparser" target="_blank" rel="noopener">bodyParser</a> middleware is built in by the framework to parse the request body of these two kinds of formats into an object mounted to <code>ctx.request.body</code>. Since it's not recommended by the HTTP protocol to pass a body by GET and HEAD methods, <code>ctx.request.body</code> cannot be used for GET and HEAD methods.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// POST /api/posts HTTP/1.1</span></span><br><span class="line"><span class="comment">// Host: localhost:3000</span></span><br><span class="line"><span class="comment">// Content-Type: application/json; charset=UTF-8</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// &#123;"title": "controller", "content": "what is controller"&#125;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> listPosts() &#123;</span><br><span class="line">    assert.equal(<span class="keyword">this</span>.ctx.request.body.title, <span class="string">'controller'</span>);</span><br><span class="line">    assert.equal(<span class="keyword">this</span>.ctx.request.body.content, <span class="string">'what is controller'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>The framework configures some default parameters for bodyParser and has the following features:</p>
<ul>
<li>when Content-Type is <code>application/json</code>, <code>application/json-patch+json</code>, <code>application/vnd.api+json</code> and <code>application/csp-report</code>, it parses the request body as JSON format and limits the maximum length of the body down to <code>100kb</code>.</li>
<li>when Content-Type is <code>application/x-www-form-urlencoded</code>, it parses the request body as Form format and limits the maximum length of the body down to <code>100kb</code>.</li>
<li>when parses successfully, the body must be an Object(also can be an array).</li>
</ul>
<p>The mostly adjusted config field is the maximum length of the request body for parsing which can be configured in <code>config/config.default.js</code> to overwrite the default value of the framework:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  bodyParser: &#123;</span><br><span class="line">    jsonLimit: <span class="string">'1mb'</span>,</span><br><span class="line">    formLimit: <span class="string">'1mb'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>If user request exceeds the maximum length for parsing that we configured, the framework will throw an exception whose status code is <code>413</code>; if request body fails to be parsed(e.g. wrong JSON), an exception with status code <code>400</code> will be thrown.</p>
<p><strong>Note: when adjusting the maximum length of the body for bodyParser, if we have a reverse proxy(Nginx) in front of our application, we may need to adjust its configuration, so that the reverse proxy also supports the same length of request body.</strong></p>
<p><strong>A common mistake is to confuse <code>ctx.request.body</code> and <code>ctx.body</code>(which is alias for <code>ctx.response.body</code>).</strong></p>
<h3 id="acquiring-the-submitted-files"><a class="markdown-anchor" href="#acquiring-the-submitted-files">#</a> Acquiring the Submitted Files</h3>
<p>The <code>body</code> in the request can carry parameters as well as files. Generally speaking, our browsers always send files in <code>multipart/form-data</code>, and we now have two kinds of ways supporting submitting and acquiring files with the help of the framework's plugin <a href="https://github.com/eggjs/egg-multipart" target="_blank" rel="noopener">Multipart</a>.</p>
<ul>
<li>
<h4 id="file-mode"><a class="markdown-anchor" href="#file-mode">#</a> <code>File</code> Mode:</h4>
</li>
</ul>
<p>If you have no ideas about Nodejs's Stream at all, the <code>File</code> mode suits you well:</p>
<ol>
<li>In your config file, enable <code>file</code> mode first:</li>
</ol>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// config/config.default.js</span></span><br><span class="line">exports.multipart = &#123;</span><br><span class="line">  mode: <span class="string">'file'</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>Submitting / Acquiring Files:</li>
</ol>
<ol>
<li>For Single File:</li>
</ol>
<p>Your HTML static front-end codes should look like this below:</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">action</span>=<span class="string">"/upload?_csrf=&#123;&#123; ctx.csrf | safe &#125;&#125;"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">  title: <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"title"</span> /&gt;</span></span><br><span class="line">  file: <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"file"</span> <span class="attr">type</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>Upload<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>The corresponding backend codes are:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/controller/upload.js</span></span><br><span class="line"><span class="keyword">const</span> Controller = <span class="built_in">require</span>(<span class="string">'egg'</span>).Controller;</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'mz/fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> upload() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx &#125; = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">const</span> file = ctx.request.files[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">const</span> name = <span class="string">'egg-multipart-test/'</span> + path.basename(file.filename);</span><br><span class="line">    <span class="keyword">let</span> result;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// process file (e.g: upload to cloud storage)</span></span><br><span class="line">      result = <span class="keyword">await</span> ctx.oss.put(name, file.filepath);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// need to remove the tmp file</span></span><br><span class="line">      <span class="keyword">await</span> fs.unlink(file.filepath);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">      url: result.url,</span><br><span class="line">      <span class="comment">// get all field values</span></span><br><span class="line">      requestBody: ctx.request.body,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>For Multiple Files:</li>
</ol>
<p>For multiple files, with the help of <code>ctx.request.files</code>, we can loop each of them and do what process we like:</p>
<p>Your HTML static front-end codes should look like this below:</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">action</span>=<span class="string">"/upload?_csrf=&#123;&#123; ctx.csrf | safe &#125;&#125;"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">  title: <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"title"</span> /&gt;</span></span><br><span class="line">  file1: <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"file1"</span> <span class="attr">type</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line">  file2: <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"file2"</span> <span class="attr">type</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>Upload<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>The corresponding backend codes are:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/controller/upload.js</span></span><br><span class="line"><span class="keyword">const</span> Controller = <span class="built_in">require</span>(<span class="string">'egg'</span>).Controller;</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">'mz/fs'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> upload() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; ctx &#125; = <span class="keyword">this</span>;</span><br><span class="line">    <span class="built_in">console</span>.log(ctx.request.body);</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'got %d files'</span>, ctx.request.files.length);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> file <span class="keyword">of</span> ctx.request.files) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'field: '</span> + file.fieldname);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'filename: '</span> + file.filename);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'encoding: '</span> + file.encoding);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'mime: '</span> + file.mime);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'tmp filepath: '</span> + file.filepath);</span><br><span class="line">      <span class="keyword">let</span> result;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// process file (e.g: upload to cloud storage)</span></span><br><span class="line">        result = <span class="keyword">await</span> ctx.oss.put(<span class="string">'egg-multipart-test/'</span> + file.filename, file.filepath);</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// need to remove the tmp file</span></span><br><span class="line">        <span class="keyword">await</span> fs.unlink(file.filepath);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">console</span>.log(result);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>
<h4 id="stream-mode"><a class="markdown-anchor" href="#stream-mode">#</a> <code>Stream</code> Mode</h4>
</li>
</ul>
<p>If you are very familiar with <code>Stream</code> in Nodejs, you can choose this way. In a controller, we can fetch the uploaded files through <code>ctx.getFileStream()</code>.</p>
<ol>
<li>For Single File：</li>
</ol>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">action</span>=<span class="string">"/upload?_csrf=&#123;&#123; ctx.csrf | safe &#125;&#125;"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">  title: <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"title"</span> /&gt;</span></span><br><span class="line">  file: <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">"file"</span> <span class="attr">type</span>=<span class="string">"file"</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>Upload<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> sendToWormhole = <span class="built_in">require</span>(<span class="string">'stream-wormhole'</span>);</span><br><span class="line"><span class="keyword">const</span> Controller = <span class="built_in">require</span>(<span class="string">'egg'</span>).Controller;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UploaderController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> upload() &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.ctx;</span><br><span class="line">    <span class="keyword">const</span> stream = <span class="keyword">await</span> ctx.getFileStream();</span><br><span class="line">    <span class="keyword">const</span> name = <span class="string">'egg-multipart-test/'</span> + path.basename(stream.filename);</span><br><span class="line">    <span class="keyword">let</span> result;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// process file (e.g: upload to cloud storage)</span></span><br><span class="line">      result = <span class="keyword">await</span> ctx.oss.put(name, stream);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="comment">// You MUST consume the file stream, otherwises the browser cannot response any more</span></span><br><span class="line">      <span class="keyword">await</span> sendToWormhole(stream);</span><br><span class="line">      <span class="keyword">throw</span> err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">      url: result.url,</span><br><span class="line">      <span class="comment">// All the fields in the form can be fetched through `stream.fields`</span></span><br><span class="line">      fields: stream.fields,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = UploaderController;</span><br></pre></td></tr></table></figure>
<p>To acquire the uploaded files easily, there're two conditions at least:</p>
<ul>
<li>Only ONE file per time.</li>
<li>The field of uploading file MUST be after the other fields in a form, otherwise you cannot get other fields after getting the file stream.</li>
</ul>
<ol start="2">
<li>For Multiple Files:</li>
</ol>
<p>For multiple files, you should do the following instead of using <code>ctx.getFileStream()</code>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="keyword">const</span> sendToWormhole = <span class="built_in">require</span>(<span class="string">'stream-wormhole'</span>);</span><br><span class="line"><span class="keyword">const</span> Controller = <span class="built_in">require</span>(<span class="string">'egg'</span>).Controller;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UploaderController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> upload() &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.ctx;</span><br><span class="line">    <span class="keyword">const</span> parts = ctx.multipart();</span><br><span class="line">    <span class="keyword">let</span> part;</span><br><span class="line">    <span class="comment">// parts() return a promise</span></span><br><span class="line">    <span class="keyword">while</span> ((part = <span class="keyword">await</span> parts()) != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (part.length) &#123;</span><br><span class="line">        <span class="comment">// arrays are busboy fields</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'field: '</span> + part[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'value: '</span> + part[<span class="number">1</span>]);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'valueTruncated: '</span> + part[<span class="number">2</span>]);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'fieldnameTruncated: '</span> + part[<span class="number">3</span>]);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!part.filename) &#123;</span><br><span class="line">          <span class="comment">// When a user clicks `upload` before choosing a file,</span></span><br><span class="line">          <span class="comment">// `part` will be file stream, but `part.filename` is empty.</span></span><br><span class="line">          <span class="comment">// We must handler this by notifying the user that he/she should</span></span><br><span class="line">          <span class="comment">// choose a file before submitting</span></span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// otherwise, it's a fully-filled stream</span></span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'field: '</span> + part.fieldname);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'filename: '</span> + part.filename);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'encoding: '</span> + part.encoding);</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">'mime: '</span> + part.mime);</span><br><span class="line">        <span class="keyword">let</span> result;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// process file (e.g: upload to cloud storage)</span></span><br><span class="line">          result = <span class="keyword">await</span> ctx.oss.put(<span class="string">'egg-multipart-test/'</span> + part.filename, part);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">          <span class="comment">// You MUST consume the file stream, otherwises the browser cannot response any more</span></span><br><span class="line">          <span class="keyword">await</span> sendToWormhole(part);</span><br><span class="line">          <span class="keyword">throw</span> err;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">console</span>.log(result);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'and we are done parsing the form!'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = UploaderController;</span><br></pre></td></tr></table></figure>
<p>The framework also has the limits for the safety of uploading files, the default white list is:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// images</span></span><br><span class="line"><span class="string">'.jpg'</span>, <span class="string">'.jpeg'</span>, <span class="comment">// image/jpeg</span></span><br><span class="line"><span class="string">'.png'</span>, <span class="comment">// image/png, image/x-png</span></span><br><span class="line"><span class="string">'.gif'</span>, <span class="comment">// image/gif</span></span><br><span class="line"><span class="string">'.bmp'</span>, <span class="comment">// image/bmp</span></span><br><span class="line"><span class="string">'.wbmp'</span>, <span class="comment">// image/vnd.wap.wbmp</span></span><br><span class="line"><span class="string">'.webp'</span>,</span><br><span class="line"><span class="string">'.tif'</span>,</span><br><span class="line"><span class="string">'.psd'</span>,</span><br><span class="line"><span class="comment">// text</span></span><br><span class="line"><span class="string">'.svg'</span>,</span><br><span class="line"><span class="string">'.js'</span>, <span class="string">'.jsx'</span>,</span><br><span class="line"><span class="string">'.json'</span>,</span><br><span class="line"><span class="string">'.css'</span>, <span class="string">'.less'</span>,</span><br><span class="line"><span class="string">'.html'</span>, <span class="string">'.htm'</span>,</span><br><span class="line"><span class="string">'.xml'</span>,</span><br><span class="line"><span class="comment">// tar</span></span><br><span class="line"><span class="string">'.zip'</span>,</span><br><span class="line"><span class="string">'.gz'</span>, <span class="string">'.tgz'</span>, <span class="string">'.gzip'</span>,</span><br><span class="line"><span class="comment">// video</span></span><br><span class="line"><span class="string">'.mp3'</span>,</span><br><span class="line"><span class="string">'.mp4'</span>,</span><br><span class="line"><span class="string">'.avi'</span>,</span><br></pre></td></tr></table></figure>
<p>Users can add new file extensions in <code>config/config.default.js</code>, or rewrite a whole white list:</p>
<ul>
<li>Newly-added a file extension:</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  multipart: &#123;</span><br><span class="line">    fileExtensions: [ <span class="string">'.apk'</span> ], <span class="comment">// Add support for apk files</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>Overwriting a whole white list:</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  multipart: &#123;</span><br><span class="line">    whitelist: [ <span class="string">'.png'</span> ] <span class="comment">// ONLY files of png is allowed</span></span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>Notice：<code>fileExtensions</code> will be IGNORED when <code>whitelist</code> is overwritten.</strong></p>
<p>For more tech details about this, please refer <a href="https://github.com/eggjs/egg-multipart" target="_blank" rel="noopener">Egg-Multipart</a>.</p>
<h3 id="header"><a class="markdown-anchor" href="#header">#</a> <code>header</code></h3>
<p>Apart from URL and request body, some parameters can be sent by request header. The framework provides some helper attributes and methods to retrieve them.</p>
<ul>
<li><code>ctx.headers</code>, <code>ctx.header</code>, <code>ctx.request.headers</code>, <code>ctx.request.header</code>: these methods are equivalent and all of them get the whole header object.</li>
<li><code>ctx.get(name)</code>, <code>ctx.request.get(name)</code>: get the value of one parameter from the request header, if the parameter does not exist, an empty string will be returned.</li>
<li>We recommend you use <code>ctx.get(name)</code> rather than <code>ctx.headers['name']</code> because the former handles upper/lower case automatically.</li>
</ul>
<p>Since header is special, some of which are given specific meanings by the <code>HTTP</code> protocol (like <code>Content-Type</code>, <code>Accept</code>), some are set by the reverse proxy as a convention (X-Forwarded-For), and the framework provides some convenient getters for them as well, for more details please refer to <a href="https://eggjs.org/api/">API</a>.</p>
<p>Specially when we set <code>config.proxy = true</code> to deploy the application behind the reverse proxy (Nginx), some Getters' internal process may be changed.</p>
<h4 id="ctxhost"><a class="markdown-anchor" href="#ctxhost">#</a> <code>ctx.host</code></h4>
<p>Reads the header's value configured by <code>config.hostHeaders</code> firstly, if fails, then it tries to get the value of host header, if fails again, it returns an empty string.</p>
<p><code>config.hostHeaders</code> defaults to <code>x-forwarded-host</code>.</p>
<h4 id="ctxprotocol"><a class="markdown-anchor" href="#ctxprotocol">#</a> <code>ctx.protocol</code></h4>
<p>When you get protocol through this Getter, it checks whether current connection is an encrypted one or not, if it is, it returns HTTPS.</p>
<p>When current connection is not an encrypted one, it reads the header's value configured by <code>config.protocolHeaders</code> to check HTTP or HTTPS, if it fails, we can set a safe-value(defaults to HTTP) through <code>config.protocol</code> in the configuration.</p>
<p><code>config.protocolHeaders</code> defaults to <code>x-forwarded-proto</code>.</p>
<h4 id="ctxips"><a class="markdown-anchor" href="#ctxips">#</a> <code>ctx.ips</code></h4>
<p>A IP address list of all intermediate equipments that a request go through can be get by <code>ctx.ips</code>, only when <code>config.proxy = true</code>, it reads the header's value configured by <code>config.ipHeaders</code> instead, if fails, it returns an empty array.</p>
<p><code>config.ipHeaders</code> defaults to <code>x-forwarded-for</code>.</p>
<h4 id="ctxip"><a class="markdown-anchor" href="#ctxip">#</a> <code>ctx.ip</code></h4>
<p>The IP address of the sender of the request can be get by <code>ctx.ip</code>, it reads from <code>ctx.ips</code> firstly, if <code>ctx.ips</code> is empty, it returns the connection sender's IP address.</p>
<p><strong>Note: <code>ip</code> and <code>ips</code> are different, if <code>config.proxy = false</code>, <code>ip</code> returns the connection sender's IP address while <code>ips</code> returns an empty array.</strong></p>
<h3 id="cookie"><a class="markdown-anchor" href="#cookie">#</a> Cookie</h3>
<p>All HTTP requests are stateless but, on the contrary, our Web applications usually need to know who sends the requests. To make it through, the HTTP protocol designs a special request header: <a href="https://en.wikipedia.org/wiki/HTTP_cookie" target="_blank" rel="noopener">Cookie</a>. With the response header (set-cookie), the server is able to send a few data to the client, the browser saves these data according to the protocol and brings them along with the next request(according to the protocol and for safety reasons, only when accessing websites that match the rules specified by Cookie does the browser bring related Cookies).</p>
<p>Through <code>ctx.cookies</code>, we can conveniently and safely set and get Cookie in Controller.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CookieController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> add() &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.ctx;</span><br><span class="line">    <span class="keyword">const</span> count = ctx.cookies.get(<span class="string">'count'</span>);</span><br><span class="line">    count = count ? <span class="built_in">Number</span>(count) : <span class="number">0</span>;</span><br><span class="line">    ctx.cookies.set(<span class="string">'count'</span>, ++count);</span><br><span class="line">    ctx.body = count;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> remove() &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.ctx;</span><br><span class="line">    <span class="keyword">const</span> count = ctx.cookies.set(<span class="string">'count'</span>, <span class="literal">null</span>);</span><br><span class="line">    ctx.status = <span class="number">204</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Although Cookie is only a header in HTTP, multiple key-value pairs can be set in the format of <code>foo=bar;foo1=bar1;</code>.</p>
<p>In Web applications, Cookie is usually used to send the identity information of the client, so it has many safety related configurations which can not be ignored, <a href="../core/cookie-and-session.html#cookie">Cookie</a> explains the usage and safety related configurations of Cookie in detail and is worth being read in depth.</p>
<h3 id="session"><a class="markdown-anchor" href="#session">#</a> Session</h3>
<p>By using Cookie, we can create an individual Session specific to every user to store user identity information, which will be encrypted then stored in Cookie to perform session persistence across requests.</p>
<p>The framework builds in <a href="https://github.com/eggjs/egg-session" target="_blank" rel="noopener">Session</a> plugin, which provides <code>ctx.session</code> for us to get or set current user's Session.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> fetchPosts() &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.ctx;</span><br><span class="line">    <span class="comment">// get data from Session</span></span><br><span class="line">    <span class="keyword">const</span> userId = ctx.session.userId;</span><br><span class="line">    <span class="keyword">const</span> posts = <span class="keyword">await</span> ctx.service.post.fetch(userId);</span><br><span class="line">    <span class="comment">// set value to Session</span></span><br><span class="line">    ctx.session.visited = ctx.session.visited ? ++ctx.session.visited : <span class="number">1</span>;</span><br><span class="line">    ctx.body = &#123;</span><br><span class="line">      success: <span class="literal">true</span>,</span><br><span class="line">      posts,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>It's quite intuitional to use Session, just get or set directly, if you want to delete it, you can assign it to <code>null</code>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SessionController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> deleteSession() &#123;</span><br><span class="line">    <span class="keyword">this</span>.ctx.session = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Like Cookie, Session has many safety related configurations and functions etc., so it's better to read <a href="../core/cookie-and-session.html#session">Session</a> in depth in ahead.</p>
<h4 id="configuration"><a class="markdown-anchor" href="#configuration">#</a> Configuration</h4>
<p>There are mainly these attributes below can be used to configure Session in <code>config.default.js</code>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  key: <span class="string">'EGG_SESS'</span>, <span class="comment">// the name of key-value pairs, which is specially used by Cookie to store Session</span></span><br><span class="line">  maxAge: <span class="number">86400000</span>, <span class="comment">// Session maximum valid time</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="parameter-validation"><a class="markdown-anchor" href="#parameter-validation">#</a> Parameter Validation</h2>
<p>After getting parameters from user requests, in most cases, it is inevitable to validate these parameters.</p>
<p>With the help of the convenient parameter validation mechanism provided by <a href="https://github.com/eggjs/egg-validate" target="_blank" rel="noopener">Validate</a> plugin, with which we can do all kinds of complex parameter validations.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// config/plugin.js</span></span><br><span class="line">exports.validate = &#123;</span><br><span class="line">  enable: <span class="literal">true</span>,</span><br><span class="line">  package: <span class="string">'egg-validate'</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>Validate parameters directly through <code>ctx.validate(rule, [body])</code>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> create() &#123;</span><br><span class="line">    <span class="comment">// validate parameters</span></span><br><span class="line">    <span class="comment">// if the second parameter is absent, `ctx.request.body` is validated automatically</span></span><br><span class="line">    <span class="keyword">this</span>.ctx.validate(&#123;</span><br><span class="line">      title: &#123; <span class="attr">type</span>: <span class="string">'string'</span> &#125;,</span><br><span class="line">      content: &#123; <span class="attr">type</span>: <span class="string">'string'</span> &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>When the validation fails, an exception will be thrown immediately with an error code of 422 and an errors field containing the detailed information why it fails. You can capture this exception through <code>try catch</code> and handle it all by yourself.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> create() &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.ctx;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      ctx.validate(createRule);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      ctx.logger.warn(err.errors);</span><br><span class="line">      ctx.body = &#123; <span class="attr">success</span>: <span class="literal">false</span> &#125;;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="validation-rules"><a class="markdown-anchor" href="#validation-rules">#</a> Validation Rules</h3>
<p>The parameter validation is done by <a href="https://github.com/node-modules/parameter#rule" target="_blank" rel="noopener">Parameter</a>, and all supported validation rules can be found in its document.</p>
<h4 id="customizing-validation-rules"><a class="markdown-anchor" href="#customizing-validation-rules">#</a> Customizing Validation Rules</h4>
<p>In addition to built-in validation types introduced in the previous section, sometimes we hope to customize several validation rules to make the development more convenient and now customized rules can be added through <code>app.validator.addRule(type, check)</code>.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line">app.validator.addRule(<span class="string">'json'</span>, (rule, value) =&gt; &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">JSON</span>.parse(value);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'must be json string'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>After adding the customized rule, it can be used immediately in Controller to do parameter validation.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> handler() &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.ctx;</span><br><span class="line">    <span class="comment">// query.test field must be a json string</span></span><br><span class="line">    <span class="keyword">const</span> rule = &#123; <span class="attr">test</span>: <span class="string">'json'</span> &#125;;</span><br><span class="line">    ctx.validate(rule, ctx.query);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="using-service"><a class="markdown-anchor" href="#using-service">#</a> Using Service</h2>
<p>We do not prefer to implement too many business logics in Controller, so a <a href="./service.html">Service</a> layer is provided to encapsulate business logics, which not only increases the reusability of codes but also makes it easy for us to test our business logics.</p>
<p>In Controller, any method of any Service can be called and, in the meanwhile, Service is lazy loaded which means it is only initialized by the framework on the first time it is accessed.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> create() &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.ctx;</span><br><span class="line">    <span class="keyword">const</span> author = ctx.session.userId;</span><br><span class="line">    <span class="keyword">const</span> req = <span class="built_in">Object</span>.assign(ctx.request.body, &#123; author &#125;);</span><br><span class="line">    <span class="comment">// using service to handle business logics</span></span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> ctx.service.post.create(req);</span><br><span class="line">    ctx.body = &#123; <span class="attr">id</span>: res.id &#125;;</span><br><span class="line">    ctx.status = <span class="number">201</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>To write a Service in detail, please refer to <a href="./service.html">Service</a>.</p>
<h2 id="sending-http-response"><a class="markdown-anchor" href="#sending-http-response">#</a> Sending HTTP Response</h2>
<p>After business logics are handled, the last thing Controller should do is to send the processing result to users with an HTTP response.</p>
<h3 id="setting-status"><a class="markdown-anchor" href="#setting-status">#</a> Setting Status</h3>
<p>HTTP designs many <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes" target="_blank" rel="noopener">Status Code</a>, each of which indicates a specific meaning, and setting the status code correctly makes the response more semantic.</p>
<p>The framework provides a convenient Setter to set the status code:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> create() &#123;</span><br><span class="line">    <span class="comment">// set status code to 201</span></span><br><span class="line">    <span class="keyword">this</span>.ctx.status = <span class="number">201</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>As to which status code should be used for a specific case, please refer to status code meanings on <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes" target="_blank" rel="noopener">List of HTTP status codes</a></p>
<h3 id="body-setting"><a class="markdown-anchor" href="#body-setting">#</a> Body Setting</h3>
<p>Most data is sent to requesters through the body and, just like the body in the request, the body sent by the response demands a set of corresponding Content-Type to inform clients how to parse data.</p>
<ul>
<li>for a RESTful API controller, we usually send a body whose Content-Type is <code>application/json</code>, indicating it's a JSON string.</li>
<li>for a HTML page controller, we usually send a body whose Content-Type is <code>text/html</code>, indicating it's a piece of HTML code.</li>
</ul>
<p><strong>Note: <code>ctx.body</code> is alias of <code>ctx.response.body</code>, don't confuse with <code>ctx.request.body</code>.</strong></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ViewController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> show() &#123;</span><br><span class="line">    <span class="keyword">this</span>.ctx.body = &#123;</span><br><span class="line">      name: <span class="string">'egg'</span>,</span><br><span class="line">      category: <span class="string">'framework'</span>,</span><br><span class="line">      language: <span class="string">'Node.js'</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> page() &#123;</span><br><span class="line">    <span class="keyword">this</span>.ctx.body = <span class="string">'&lt;html&gt;&lt;h1&gt;Hello&lt;/h1&gt;&lt;/html&gt;'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Due to the Stream feature of Node.js, we need to return the response by Stream in some cases, e.g., returning a big file, the proxy server returns content from upstream straightforward, the framework also supports setting the body into a Stream directly and handling error events on this stream well in the meanwhile.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> proxy() &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.ctx;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">await</span> ctx.curl(url, &#123;</span><br><span class="line">      streaming: <span class="literal">true</span>,</span><br><span class="line">    &#125;);</span><br><span class="line">    ctx.set(result.header);</span><br><span class="line">    <span class="comment">// result.res is stream</span></span><br><span class="line">    ctx.body = result.res;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="rendering-template"><a class="markdown-anchor" href="#rendering-template">#</a> Rendering Template</h4>
<p>Usually we do not write HTML pages by hand, instead we generate them by a template engine.
Egg itself does not integrate any template engine, but it establishes the <a href="../advanced/view-plugin.html">View Plugin Specification</a>. Once the template engine is loaded, <code>ctx.render(template)</code> can be used to render templates to HTML directly.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HomeController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> index() &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.ctx;</span><br><span class="line">    <span class="keyword">await</span> ctx.render(<span class="string">'home.tpl'</span>, &#123; <span class="attr">name</span>: <span class="string">'egg'</span> &#125;);</span><br><span class="line">    <span class="comment">// ctx.body = await ctx.renderString('hi, &#123;&#123; name &#125;&#125;', &#123; name: 'egg' &#125;);</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>For detailed examples, please refer to <a href="../core/view.html">Template Rendering</a>.</p>
<h4 id="jsonp"><a class="markdown-anchor" href="#jsonp">#</a> JSONP</h4>
<p>Sometimes we need to provide API services for pages in a different domain, and, for historical reasons, <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS" target="_blank" rel="noopener">CORS</a> fails to make it through, while <a href="https://en.wikipedia.org/wiki/JSONP" target="_blank" rel="noopener">JSONP</a> does.</p>
<p>Since misuse of JSONP leads to dozens of security issues, the framework supplies a convenient way to respond JSONP data, encapsulating <a href="../core/security.html#jsonp-xss">JSONP XSS Related Security Precautions</a>, and supporting the validation of CSRF and referrer.</p>
<ul>
<li><code>app.jsonp()</code> provides a middleware for the controller to respond JSONP data. We may add this middleware to the router that needs to support jsonp:</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/router.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> jsonp = app.jsonp();</span><br><span class="line">  app.router.get(<span class="string">'/api/posts/:id'</span>, jsonp, app.controller.posts.show);</span><br><span class="line">  app.router.get(<span class="string">'/api/posts'</span>, jsonp, app.controller.posts.list);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<ul>
<li>We just program as usual in the Controller:</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/controller/posts.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PostController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> show() &#123;</span><br><span class="line">    <span class="keyword">this</span>.ctx.body = &#123;</span><br><span class="line">      name: <span class="string">'egg'</span>,</span><br><span class="line">      category: <span class="string">'framework'</span>,</span><br><span class="line">      language: <span class="string">'Node.js'</span>,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>When user's requests access this controller through a corresponding URL, if the query contains the <code>_callback=fn</code> parameter, data is returned in JSONP format, otherwise in JSON format.</p>
<h5 id="jsonp-configuration"><a class="markdown-anchor" href="#jsonp-configuration">#</a> JSONP Configuration</h5>
<p>By default, the framework determines whether to return data in JSONP format or not depending on the <code>_callback</code> parameter in the query, and the method name set by <code>_callback</code> must be less than 50 characters. Applications may overwrite the default configuration globally in <code>config/config.default.js</code>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// config/config.default.js</span></span><br><span class="line">exports.jsonp = &#123;</span><br><span class="line">  callback: <span class="string">'callback'</span>, <span class="comment">// inspecting the `callback` parameter in the query</span></span><br><span class="line">  limit: <span class="number">100</span>, <span class="comment">// the maximum size of the method name is 100 characters</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>With the configuration above, if a user requests <code>/api/posts/1?callback=fn</code>, a JSONP format response is sent, if <code>/api/posts/1</code>, a JSON format response is sent.</p>
<p>Also we can overwrite the default configuration in <code>app.jsonp()</code> when creating the middleware and therefore separate configurations is used for separate routers:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/router.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; router, controller, jsonp &#125; = app;</span><br><span class="line">  router.get(<span class="string">'/api/posts/:id'</span>, jsonp(&#123; <span class="attr">callback</span>: <span class="string">'callback'</span> &#125;), controller.posts.show);</span><br><span class="line">  router.get(<span class="string">'/api/posts'</span>, jsonp(&#123; <span class="attr">callback</span>: <span class="string">'cb'</span> &#125;), controller.posts.list);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="xss-defense-configuration"><a class="markdown-anchor" href="#xss-defense-configuration">#</a> XSS Defense Configuration</h4>
<p>By default, XSS is not defended when responding JSONP, and, in some cases, it is quite dangerous. We classify JSONP APIs into three type grossly:</p>
<ol>
<li>querying non-sensitive data, e.g. getting the public post list of a BBS.</li>
<li>querying sensitive data, e.g. getting the transaction record of a user.</li>
<li>submitting data and modifying the database, e.g. create a new order for a user.</li>
</ol>
<p>If our JSONP API provides the last two type services and, without any XSS defense, user's sensitive data may be leaked and even user may be phished. Given this, the framework supports the validations of CSRF and referrer by default.</p>
<h5 id="csrf"><a class="markdown-anchor" href="#csrf">#</a> CSRF</h5>
<p>In the JSONP configuration, we could enable the CSRF validation for JSONP APIs simply by setting <code>csrf: true</code>.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// config/config.default.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  jsonp: &#123;</span><br><span class="line">    csrf: <span class="literal">true</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>Note: the CSRF validation depends on the Cookie based CSRF validation provided by <a href="../core/security.html">security</a>.</strong></p>
<p>When the CSRF validation is enabled, the client should bring CSRF token as well when it sends a JSONP request, if the page where the JSONP sender belongs to shares the same domain with our services, CSRF token in Cookie can be read(CSRF can be set manually if it is absent), and is brought together with the request.</p>
<h5 id="validation-reference"><a class="markdown-anchor" href="#validation-reference">#</a> Validation Reference</h5>
<p>The CSRF way can be used for JSONP request validation only if the main domains are the same, while providing JSONP services for pages in different domains, we can limit JSONP senders into a controllable rang by configuring the referrer whitelist.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">//config/config.default.js</span></span><br><span class="line">exports.jsonp = &#123;</span><br><span class="line">  whiteList: <span class="regexp">/^https?:\/\/test.com\//</span>,</span><br><span class="line">  <span class="comment">// whiteList: '.test.com',</span></span><br><span class="line">  <span class="comment">// whiteList: 'sub.test.com',</span></span><br><span class="line">  <span class="comment">// whiteList: [ 'sub.test.com', 'sub2.test.com' ],</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>whileList</code> can be configured as regular expression, string and array:</p>
<ul>
<li>Regular Expression: only requests whose Referrer match the regular expression are allowed to access the JSONP API. When composing the regular expression, please also notice the leading <code>^</code> and tail <code>\/</code> which guarantees the whole domain matches.</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">exports.jsonp = &#123;</span><br><span class="line">  whiteList: <span class="regexp">/^https?:\/\/test.com\//</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// matches referrer:</span></span><br><span class="line"><span class="comment">// https://test.com/hello</span></span><br><span class="line"><span class="comment">// http://test.com/</span></span><br></pre></td></tr></table></figure>
<ul>
<li>String: two cases exists when configuring the whitelist as a string, if the string begins with a <code>.</code>, e.g. <code>.test.com</code>, the referrer whitelist indicates all sub-domains of <code>test.com</code>, <code>test.com</code> itself included. if the string does not begin with a <code>.</code>, e.g. <code>sub.test.com</code>, it indicates <code>sub.test.com</code> one domain only. (both HTTP and HTTPS are supported)</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">exports.jsonp = &#123;</span><br><span class="line">  whiteList: <span class="string">'.test.com'</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// matches domain test.com:</span></span><br><span class="line"><span class="comment">// https://test.com/hello</span></span><br><span class="line"><span class="comment">// http://test.com/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// matches subdomain</span></span><br><span class="line"><span class="comment">// https://sub.test.com/hello</span></span><br><span class="line"><span class="comment">// http://sub.sub.test.com/</span></span><br><span class="line"></span><br><span class="line">exports.jsonp = &#123;</span><br><span class="line">  whiteList: <span class="string">'sub.test.com'</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// only matches domain sub.test.com:</span></span><br><span class="line"><span class="comment">// https://sub.test.com/hello</span></span><br><span class="line"><span class="comment">// http://sub.test.com/</span></span><br></pre></td></tr></table></figure>
<ul>
<li>Array: when the whitelist is configured as an array, the referrer validation is passed only if at least one condition represented by array items is matched.</li>
</ul>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">exports.jsonp = &#123;</span><br><span class="line">  whiteList: [ <span class="string">'sub.test.com'</span>, <span class="string">'sub2.test.com'</span> ],</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// matches domain sub.test.com and sub2.test.com:</span></span><br><span class="line"><span class="comment">// https://sub.test.com/hello</span></span><br><span class="line"><span class="comment">// http://sub2.test.com/</span></span><br></pre></td></tr></table></figure>
<p><strong>If both CSRF and referrer validation are enabled, the request sender passes any one of them passes the JSONP security validation.</strong></p>
<h3 id="header-setting"><a class="markdown-anchor" href="#header-setting">#</a> Header Setting</h3>
<p>We identify whether the request is successful or not by using the status code and set response content in the body. By setting the response header, extended information can be set as well.</p>
<p><code>ctx.set(key, value)</code> sets one response header and <code>ctx.set(headers)</code> sets many in one time.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/controller/api.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProxyController</span> <span class="keyword">extends</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> show() &#123;</span><br><span class="line">    <span class="keyword">const</span> ctx = <span class="keyword">this</span>.ctx;</span><br><span class="line">    <span class="keyword">const</span> start = <span class="built_in">Date</span>.now();</span><br><span class="line">    ctx.body = <span class="keyword">await</span> ctx.service.post.get();</span><br><span class="line">    <span class="keyword">const</span> used = <span class="built_in">Date</span>.now() - start;</span><br><span class="line">    <span class="comment">// set one response header</span></span><br><span class="line">    ctx.set(<span class="string">'show-response-time'</span>, used.toString());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="redirect"><a class="markdown-anchor" href="#redirect">#</a> Redirect</h3>
<p>The framework overwrites koa's native <code>ctx.redirect</code> implementation with a security plugin to provide a more secure redirect.</p>
<ul>
<li><code>ctx.redirect(url)</code> Forbids redirect if it is not in the configured whitelist domain name.</li>
<li><code>ctx.unsafeRedirect(url)</code> does not determine the domain name and redirect directly. Generally, it is not recommended to use it. Use it after clearly understanding the possible risks.</li>
</ul>
<p>If you use the <code>ctx.redirect</code> method, you need to configure the application configuration file as follows:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// config/config.default.js</span></span><br><span class="line">exports.security = &#123;</span><br><span class="line">  domainWhiteList:[<span class="string">'.domain.com'</span>],  <span class="comment">// Security whitelist, starts with `.`</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>If the user does not configure the <code>domainWhiteList</code> or the <code>domainWhiteList</code> array to be empty, then all redirect requests will be released by default, which is equivalent to <code>ctx.unsafeRedirect(url)</code>.</p>
    
        </article>  
      </div>      
  </div>

  <div class="toc" id="toc">
  <ol class="toc-detail"><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#what-is-controller"><span class="toc-detail-number">1.</span> <span class="toc-detail-text"># What is Controller</span></a></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#how-to-write-controller"><span class="toc-detail-number">2.</span> <span class="toc-detail-text"># How To Write Controller</span></a><ol class="toc-detail-child"><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#controller-classrecommended"><span class="toc-detail-number">2.1.</span> <span class="toc-detail-text"># Controller Class(Recommended)</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#methods-style-controller-its-not-recommended-only-for-compatibility"><span class="toc-detail-number">2.2.</span> <span class="toc-detail-text"># Methods Style Controller (It&#39;s not recommended, only for compatibility)</span></a></li></ol></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#http-basics"><span class="toc-detail-number">3.</span> <span class="toc-detail-text"># HTTP Basics</span></a></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#acquire-http-request-parameters"><span class="toc-detail-number">4.</span> <span class="toc-detail-text"># Acquire HTTP Request Parameters</span></a><ol class="toc-detail-child"><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#query"><span class="toc-detail-number">4.1.</span> <span class="toc-detail-text"># query</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#router-params"><span class="toc-detail-number">4.2.</span> <span class="toc-detail-text"># Router Params</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#body"><span class="toc-detail-number">4.3.</span> <span class="toc-detail-text"># body</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#acquiring-the-submitted-files"><span class="toc-detail-number">4.4.</span> <span class="toc-detail-text"># Acquiring the Submitted Files</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#header"><span class="toc-detail-number">4.5.</span> <span class="toc-detail-text"># header</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#cookie"><span class="toc-detail-number">4.6.</span> <span class="toc-detail-text"># Cookie</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#session"><span class="toc-detail-number">4.7.</span> <span class="toc-detail-text"># Session</span></a></li></ol></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#parameter-validation"><span class="toc-detail-number">5.</span> <span class="toc-detail-text"># Parameter Validation</span></a><ol class="toc-detail-child"><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#validation-rules"><span class="toc-detail-number">5.1.</span> <span class="toc-detail-text"># Validation Rules</span></a></li></ol></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#using-service"><span class="toc-detail-number">6.</span> <span class="toc-detail-text"># Using Service</span></a></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#sending-http-response"><span class="toc-detail-number">7.</span> <span class="toc-detail-text"># Sending HTTP Response</span></a><ol class="toc-detail-child"><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#setting-status"><span class="toc-detail-number">7.1.</span> <span class="toc-detail-text"># Setting Status</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#body-setting"><span class="toc-detail-number">7.2.</span> <span class="toc-detail-text"># Body Setting</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#header-setting"><span class="toc-detail-number">7.3.</span> <span class="toc-detail-text"># Header Setting</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#redirect"><span class="toc-detail-number">7.4.</span> <span class="toc-detail-text"># Redirect</span></a></li></ol></li></ol>
</div>

<script>

var tocContainer = document.getElementById('toc');
var tocDetail = document.getElementsByClassName('toc-detail')[0];

(function(){
  if(!tocDetail){
    tocContainer.style.display = 'none';
  }

  if(tocDetail){
    document.querySelectorAll('.toc-detail-text').forEach(function(element){
      element.innerText = element.innerText.replace('# ', '');
    });
  }
})();
</script>

</div>

  </div>
</body>
<script src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script>
<script>
docsearch({
  apiKey: '1561de31a86f79507ea00cdb54ce647c',
  indexName: 'eggjs',
  inputSelector: '#search-query',
});
</script>
<div class="cnzz">
<script src="https://s11.cnzz.com/z_stat.php?id=1261142226&web_id=1261142226" language="JavaScript"></script>
</div>

</html>
