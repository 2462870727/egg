<!DOCTYPE html>
<html lang="en">
<head><meta name="generator" content="Hexo 3.9.0">
  <title>Loader - Born to build better enterprise frameworks and apps</title>
  <meta charset="utf-8">
  <meta name="description" content="index.description">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <link rel="icon" href="/images/favicon.png" type="image/x-icon">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.css">
<link rel="stylesheet" href="/css/index.css">

    <script>
    !function(t,e,a,r,c){t.TracertCmdCache=t.TracertCmdCache||[],t[c]=window[c]||
      {_isInit:!0,call:function(){t.TracertCmdCache.push(arguments)},
      start:function(t){this.call('start',t)}},t[c].l=new Date;
      var n=e.createElement(a),s=e.getElementsByTagName(a)[0];
      n.async=!0,n.src=r,s.parentNode.insertBefore(n,s)}
    (window,document,'script','https://tracert.alipay.com/tracert.js','Tracert');
      Tracert.start({
        plugins: [ 'BucName' ],
        spmAPos: 'a454',
        spmBPos: 'b4893',
      });
    </script>
  
<!-- Hotjar Tracking Code for https://eggjs.org -->
<script>
    (function(h,o,t,j,a,r){
        h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
        h._hjSettings={hjid:1089836,hjsv:6};
        a=o.getElementsByTagName('head')[0];
        r=o.createElement('script');r.async=1;
        r.src=t+h._hjSettings.hjid+j+h._hjSettings.hjsv;
        a.appendChild(r);
    })(window,document,'https://static.hotjar.com/c/hotjar-','.js?sv=');
</script>

</head>
<body>
  <div class="nav">
  <header>
    <a href="/en/" class="nav-logo leftpadding" alt="egg"><img src="https://zos.alipayobjects.com/rmsportal/VTcUYAaoKqXyHJbLAPyF.svg"></a>
    <ul class="nav-item">
      <li>
        <form id="search-form">
          <input type="text" id="search-query" class="search-query st-default-search-input">
        </form>
      </li>
      <li><a href="/en/intro/" alt="Guide">Guide</a></li><li><a href="/api/" alt="API">API</a></li><li><a href="/en/tutorials/index.html" alt="Tutorials">Tutorials</a></li><li><a href="https://github.com/search?q=topic%3Aegg-plugin&type=Repositories" alt="Plugins">Plugins</a></li><li><a href="https://github.com/eggjs/egg/releases" alt="Release">Release</a></li>
      
      
        <li class="translations">
          <a class="nav-link">Languages</a>
          <span class="arrow"></span><ul id="dropdownContent" class="dropdown-content"><li><a id="en" href="/en/advanced/loader.html" style="color: #22ab28">English</a></li><li><a id="zh-cn" href="/zh-cn/advanced/loader.html">中文</a></li></ul>
        </li>
      
      <li><iframe src="https://ghbtns.com/github-btn.html?user=eggjs&repo=egg&type=star&count=true" frameborder="0" scrolling="0" width="150px" height="20px"></iframe></li>
    </ul>
    <a id="mobileTrigger" href="#" class="mobile-trigger">
      <ul>
        <li></li>
        <li></li>
        <li></li>
      </ul>
    </a>
  </header>
</div>

  <div id="container" class="container">
    <div class="page-main">
  <aside id="mobileAside" class="aside">
  <div class="mobile-menu">
    <ul>
      <li><a href="/en/intro/" alt="Guide">Guide</a></li><li><a href="/api/" alt="API">API</a></li><li><a href="/en/tutorials/index.html" alt="Tutorials">Tutorials</a></li><li><a href="https://github.com/search?q=topic%3Aegg-plugin&type=Repositories" alt="Plugins">Plugins</a></li><li><a href="https://github.com/eggjs/egg/releases" alt="Release">Release</a></li>
      
      
        <li class="translations">
          <a class="nav-link">Languages</a>
          <span class="arrow"></span><ul id="dropdownContent" class="dropdown-content"><li><a id="en" href="/en/advanced/loader.html" style="color: #22ab28">English</a></li><li><a id="zh-cn" href="/zh-cn/advanced/loader.html">中文</a></li></ul>
        </li>
      
    </ul>
  </div>
  <dl><dt id="title-Intro" style="cursor: pointer;" class="aside-title">Guide<a id="collapse-icon-Intro" class="icon opend"></a></dt><dd id="panel-Intro"><ul><li><a href="/en/intro/index.html" class="menu-link">What is Egg?</a></li><li><a href="/en/intro/egg-and-koa.html" class="menu-link">Egg and Koa</a></li><li><a href="/en/intro/quickstart.html" class="menu-link">Quick Start</a></li><li><a href="/en/tutorials/progressive.html" class="menu-link">Progressive</a></li><li><a href="/en/migration.html" class="menu-link">Migration to 2.x</a></li></ul></dd><dt id="title-Basics" style="cursor: pointer;" class="aside-title">Basis Function<a id="collapse-icon-Basics" class="icon opend"></a></dt><dd id="panel-Basics"><ul><li><a href="/en/basics/structure.html" class="menu-link">Directory Structure</a></li><li><a href="/en/basics/objects.html" class="menu-link">Built-in Objects</a></li><li><a href="/en/basics/env.html" class="menu-link">Environment</a></li><li><a href="/en/basics/config.html" class="menu-link">Configuration</a></li><li><a href="/en/basics/middleware.html" class="menu-link">Middleware</a></li><li><a href="/en/basics/router.html" class="menu-link">Router</a></li><li><a href="/en/basics/controller.html" class="menu-link">Controller</a></li><li><a href="/en/basics/service.html" class="menu-link">Service</a></li><li><a href="/en/basics/plugin.html" class="menu-link">Plugin</a></li><li><a href="/en/basics/schedule.html" class="menu-link">Schedule</a></li><li><a href="/en/basics/extend.html" class="menu-link">Extend</a></li><li><a href="/en/basics/app-start.html" class="menu-link">Custom Init</a></li></ul></dd><dt id="title-Core" style="cursor: pointer;" class="aside-title">Core<a id="collapse-icon-Core" class="icon opend"></a></dt><dd id="panel-Core"><ul><li><a href="/en/core/development.html" class="menu-link">Development</a></li><li><a href="/en/core/unittest.html" class="menu-link">Unit Testing</a></li><li><a href="/en/core/deployment.html" class="menu-link">Deployment</a></li><li><a href="/en/core/logger.html" class="menu-link">Logger</a></li><li><a href="/en/core/httpclient.html" class="menu-link">HttpClient</a></li><li><a href="/en/core/cookie-and-session.html" class="menu-link">Cookie and Session</a></li><li><a href="/en/core/cluster-and-ipc.html" class="menu-link">Cluster and IPC</a></li><li><a href="/en/core/view.html" class="menu-link">View</a></li><li><a href="/en/core/error-handling.html" class="menu-link">Error Handling</a></li><li><a href="/en/core/security.html" class="menu-link">Security</a></li><li><a href="/en/core/i18n.html" class="menu-link">i18n</a></li></ul></dd><dt id="title-Tutorials" style="cursor: pointer;" class="aside-title">Tutorials<a id="collapse-icon-Tutorials" class="icon opend"></a></dt><dd id="panel-Tutorials"><ul><li><a href="/en/tutorials/mysql.html" class="menu-link">MySQL</a></li><li><a href="/en/tutorials/sequelize.html" class="menu-link">Sequelize</a></li><li><a href="/en/tutorials/restful.html" class="menu-link">RESTful API</a></li><li><a href="/en/tutorials/passport.html" class="menu-link">Passport</a></li><li><a href="/en/tutorials/socketio.html" class="menu-link">Socket.IO</a></li><li><a href="/en/tutorials/assets.html" class="menu-link">Assets</a></li><li><a href="/en/tutorials/typescript.html" class="menu-link">TypeScript</a></li><li><a href="/en/tutorials/proxy.html" class="menu-link">Behind a Proxy</a></li></ul></dd><dt id="title-Advanced" style="cursor: pointer;" class="aside-title">Advanced<a id="collapse-icon-Advanced" class="icon opend"></a></dt><dd id="panel-Advanced"><ul><li><a href="/en/advanced/loader.html" class="menu-link">Loader</a></li><li><a href="/en/advanced/plugin.html" class="menu-link">Plugin Development</a></li><li><a href="/en/advanced/framework.html" class="menu-link">Framework</a></li><li><a href="/en/advanced/cluster-client.html" class="menu-link">Cluster Enhancement</a></li><li><a href="/en/advanced/view-plugin.html" class="menu-link">View Plugin</a></li><li><a href="/en/style-guide.html" class="menu-link">Style Guide</a></li></ul></dd><dt id="title-Community" style="cursor: pointer;" class="aside-title">Community<a id="collapse-icon-Community" class="icon opend"></a></dt><dd id="panel-Community"><ul><li><a href="/en/contributing.html" class="menu-link">Contributing</a></li><li><a href="/en/resource.html" class="menu-link">Resource</a></li><li><a href="/en/faq.html" class="menu-link">FAQ</a></li></ul></dd></dl>
</aside>
<script>
var mobileTrigger = document.getElementById('mobileTrigger');
var mobileAside = document.getElementById('mobileAside');

var expandMenu = function(title) {
  // handle icon
  const collapseIcon = document.getElementById('collapse-icon-' + title);
  if (collapseIcon) {
    collapseIcon.className = 'icon opend';
  }
  // handle panelEle
  const panelEle = document.getElementById('panel-' + title);
  if (panelEle) {
    panelEle.className = '';
  }
}

var collapseMenu = function(title) {
  // handle icon
  const collapseIcon = document.getElementById('collapse-icon-' + title);
  if (collapseIcon) {
    collapseIcon.className = 'icon closed';
  }
  // handle panelEle
  const panelEle = document.getElementById('panel-' + title);
  if (panelEle) {
    panelEle.className = 'aside-panel-hidden';
  }
}

mobileAside.onclick = function(e) {
  const targetId = e.target.id;
  if (targetId && (targetId.indexOf('title-') > -1 || targetId.indexOf('collapse-icon-') > -1)) {
    const title = targetId.replace('title-', '').replace('collapse-icon-', '');
    try { 
      // the the browser may have no localStroage or JSON.parse may throw exception.
      const menuInfo = JSON.parse(window.localStorage.getItem('menuInfo'));
        
      // current menu status
      const curClosed = menuInfo[title] ? menuInfo[title].closed : false; // default false

      // change UI
      curClosed ? expandMenu(title) : collapseMenu(title);

      // save menuInfo to localStorage
      menuInfo[title] = { closed: !curClosed } // opposite
      window.localStorage.setItem('menuInfo', JSON.stringify(menuInfo));
    } catch (e) {}
  }
};

mobileTrigger.onclick = function(e) {
  e.preventDefault();
  if (mobileAside.className.indexOf('mobile-show') === -1) {
    mobileAside.className += ' mobile-show';
  } else {
    mobileAside.className = 'aside';
  }
};

(function() {
  // save data to localStorage because the page will refresh when user change the url.
  let menuInfo;
  try { 
    // the the browser may have no localStroage or JSON.parse may throw exception.
    menuInfo = JSON.parse(window.localStorage.getItem('menuInfo'));
    if (!menuInfo) {
      menuInfo = {};
      window.localStorage.setItem('menuInfo', JSON.stringify(menuInfo));
    }
  } catch (e) {
    menuInfo = {}; // default {}
  }

  for (const title in menuInfo) {
    if (menuInfo[title] && menuInfo[title].closed) { // menu in closed status.
      collapseMenu(title);
    } else {
      expandMenu(title);
    }
  }

  // highlight menu
  const pathname = window.location.pathname;
  const selector = `a[href="${pathname}"].menu-link,a[href="${pathname}index.html"].menu-link`;
  const menuItem = mobileAside.querySelector(selector);
  if (menuItem) { menuItem.className += ' highlight'; }
})();
</script>


  <div class="content">
    <div class="doc">
      <article class="markdown-body">
        <h1>Loader</h1>
          <p>The most importance of Egg which enhanced Koa is that it is based on a certain agreement, code will be placed in different directories according to the functional differences, it significantly reduces development costs. Loader supports this set of conventions and abstracts that many low-level APIs could be extended.</p>
<h2 id="application-framework-and-plugin"><a class="markdown-anchor" href="#application-framework-and-plugin">#</a> Application, Framework and Plugin</h2>
<p>Egg is a low-level framework, applications could use it directly, but Egg only has a few default plugins, we need to configure plugins to extend features in application, such as MySQL.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// application configuration</span></span><br><span class="line"><span class="comment">// package.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="string">"egg"</span>: <span class="string">"^2.0.0"</span>,</span><br><span class="line">    <span class="string">"egg-mysql"</span>: <span class="string">"^3.0.0"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// config/plugin.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mysql: &#123;</span><br><span class="line">    enable: <span class="literal">true</span>,</span><br><span class="line">    package: <span class="string">'egg-mysql'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>With the increasing number of applications, we find most of them have similar configurations, so we could extend a new framework based on Egg, which makes application configurations simpler.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// framework configuration</span></span><br><span class="line"><span class="comment">// package.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"framework1"</span>,</span><br><span class="line">  <span class="string">"version"</span>: <span class="string">"1.0.0"</span>,</span><br><span class="line">  <span class="string">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="string">"egg-mysql"</span>: <span class="string">"^3.0.0"</span>,</span><br><span class="line">    <span class="string">"egg-view-nunjucks"</span>: <span class="string">"^2.0.0"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// config/plugin.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  mysql: &#123;</span><br><span class="line">    enable: <span class="literal">false</span>,</span><br><span class="line">    package: <span class="string">'egg-mysql'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  view: &#123;</span><br><span class="line">    enable: <span class="literal">false</span>,</span><br><span class="line">    package: <span class="string">'egg-view-nunjucks'</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// application configuration</span></span><br><span class="line"><span class="comment">// package.json</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"dependencies"</span>: &#123;</span><br><span class="line">    <span class="string">"framework1"</span>: <span class="string">"^1.0.0"</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// config/plugin.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// enable plugins</span></span><br><span class="line">  mysql: <span class="literal">true</span>,</span><br><span class="line">  view: <span class="literal">true</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>From the scene above we can see the relationship of application, plugin and framework.</p>
<ul>
<li>We implement business logics in application, and specify a framework to run, so we could configure plugin to meet a special scene feature (such as MySQL).</li>
<li>Plugin only performs specific function, when two separate functions are interdependent, they still need to be separated into two plugins, and requires configuration.</li>
<li>Framework is a launcher (default is Egg), which is indispensable to run. Framework is also a wrapper, it aggregates plugins to provide functions unitedly, and it can also configure plugins.</li>
<li>We can extend a new framework based on framework, which means that <strong>framework can be inherited infinitely</strong>, like class inheritance.</li>
</ul>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">+-----------------------------------+--------+</span><br><span class="line">|      app1, app2, app3, app4       |        |</span><br><span class="line">+-----+--------------+--------------+        |</span><br><span class="line">|     |              |  framework3  |        |</span><br><span class="line">+     |  framework1  +--------------+ plugin |</span><br><span class="line">|     |              |  framework2  |        |</span><br><span class="line">+     +--------------+--------------+        |</span><br><span class="line">|                   Egg             |        |</span><br><span class="line">+-----------------------------------+--------|</span><br><span class="line">|                   Koa                      |</span><br><span class="line">+-----------------------------------+--------+</span><br></pre></td></tr></table></figure>
<h2 id="loadunit"><a class="markdown-anchor" href="#loadunit">#</a> LoadUnit</h2>
<p>Egg regards application, framework and plugin as loadUnit, because they are similar in code structure, here is the directory structure:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">loadUnit</span><br><span class="line">├── package.json</span><br><span class="line">├── app.js</span><br><span class="line">├── agent.js</span><br><span class="line">├── app</span><br><span class="line">│   ├── extend</span><br><span class="line">│   |   ├── helper.js</span><br><span class="line">│   |   ├── request.js</span><br><span class="line">│   |   ├── response.js</span><br><span class="line">│   |   ├── context.js</span><br><span class="line">│   |   ├── application.js</span><br><span class="line">│   |   └── agent.js</span><br><span class="line">│   ├── service</span><br><span class="line">│   ├── middleware</span><br><span class="line">│   └── router.js</span><br><span class="line">└── config</span><br><span class="line">    ├── config.default.js</span><br><span class="line">    ├── config.prod.js</span><br><span class="line">    ├── config.test.js</span><br><span class="line">    ├── config.local.js</span><br><span class="line">    └── config.unittest.js</span><br></pre></td></tr></table></figure>
<p>However, there are still some differences:</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Application</th>
<th>Framework</th>
<th>Plugin</th>
</tr>
</thead>
<tbody>
<tr>
<td>app/router.js</td>
<td>✔︎</td>
<td></td>
<td></td>
</tr>
<tr>
<td>app/controller</td>
<td>✔︎</td>
<td></td>
<td></td>
</tr>
<tr>
<td>app/middleware</td>
<td>✔︎</td>
<td>✔︎</td>
<td>✔︎</td>
</tr>
<tr>
<td>app/service</td>
<td>✔︎</td>
<td>✔︎</td>
<td>✔︎</td>
</tr>
<tr>
<td>app/extend</td>
<td>✔︎</td>
<td>✔︎</td>
<td>✔︎</td>
</tr>
<tr>
<td>app.js</td>
<td>✔︎</td>
<td>✔︎</td>
<td>✔︎</td>
</tr>
<tr>
<td>agent.js</td>
<td>✔︎</td>
<td>✔︎</td>
<td>✔︎</td>
</tr>
<tr>
<td>config/config.{env}.js</td>
<td>✔︎</td>
<td>✔︎</td>
<td>✔︎</td>
</tr>
<tr>
<td>config/plugin.js</td>
<td>✔︎</td>
<td>✔︎</td>
<td></td>
</tr>
<tr>
<td>package.json</td>
<td>✔︎</td>
<td>✔︎</td>
<td>✔︎</td>
</tr>
</tbody>
</table>
<p>During the loading process, Egg will traverse all loadUnits to load the files above(application, framework and plugin are different), the loading process has priority.</p>
<ul>
<li>Load according to <code>Plugin =&gt; Framework =&gt; Application</code>.</li>
<li>The order of loading plugin depends on the dependencies, dependent plugins will be loaded first, independent plugins are loaded by the object key configuration order, see <a href="./plugin.html">Plugin</a> for details.</li>
<li>Frameworks are loaded by the order of inheritance, the lower the more priority.</li>
</ul>
<p>For example, an application is configured with the following dependencies:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">app</span><br><span class="line">| ├── plugin2 (depends plugin3)</span><br><span class="line">| └── plugin3</span><br><span class="line">└── framework1</span><br><span class="line">    | └── plugin1</span><br><span class="line">    └── egg</span><br></pre></td></tr></table></figure>
<p>The final loading order is:</p>
<figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">=&gt; plugin1</span><br><span class="line">=&gt; plugin3</span><br><span class="line">=&gt; plugin2</span><br><span class="line">=&gt; egg</span><br><span class="line">=&gt; framework1</span><br><span class="line">=&gt; app</span><br></pre></td></tr></table></figure>
<p>The plugin1 is framework1's dependent plugin, the object key order of plugin1 after configuration merger is prior to plugin2/plugin3. Because of the dependencies between plugin2 and plugin3, the order is swapped. The framework1 inherits the Egg, so the order is after the egg. The application is the last to be loaded.</p>
<p>See <a href="https://github.com/eggjs/egg-core/blob/65ea778a4f2156a9cebd3951dac12c4f9455e636/lib/loader/egg_loader.js#L233" target="_blank" rel="noopener">Loader.getLoadUnits</a> method for details.</p>
<h3 id="file-order"><a class="markdown-anchor" href="#file-order">#</a> File Order</h3>
<p>The files that will be loaded by default are listed above. Egg will load files by the following order, each file or directory will be loaded according to loadUnit order (application, framework and plugin are different):</p>
<ul>
<li>Loading <a href="./plugin.html">plugin</a>, find application and framework, loading <code>config/plugin.js</code></li>
<li>Loading <a href="../basics/config.html">config</a>, traverse loadUnit to load <code>config/config.{env}.js</code></li>
<li>Loading <a href="../basics/extend.html">extend</a>, traverse loadUnit to load <code>app/extend/xx.js</code></li>
<li><a href="../basics/app-start.html">Application startup configuration</a>, traverse loadUnit to load <code>app.js</code> and <code>agent.js</code></li>
<li>Loading <a href="../basics/service.html">service</a>, traverse loadUnit to load <code>app/service</code> directory</li>
<li>Loading <a href="../basics/middleware.html">middleware</a>, traverse loadUnit to load <code>app/middleware</code> directory</li>
<li>Loading <a href="../basics/controller.html">controller</a>, loading application's <code>app/controller</code> directory</li>
<li>Loading <a href="../basics/router.html">router</a>, loading application's <code>app/router.js</code></li>
</ul>
<p>Note:</p>
<ul>
<li>Same name will be override in loading, for example, if we want to override <code>ctx.ip</code> we could define ip in application's <code>app/extend/context.js</code> directly.</li>
<li>See <a href="./framework.html">framework development</a> for detail application launch order.</li>
</ul>
<h3 id="life-cycles"><a class="markdown-anchor" href="#life-cycles">#</a> Life Cycles</h3>
<p>The framework has provided you several functions to handle during the whole life cycle:</p>
<ul>
<li><code>configWillLoad</code>: All the config files are ready to load, so this is the LAST chance to modify them.</li>
<li><code>configDidLoad</code>: When all the config files have been loaded.</li>
<li><code>didLoad</code>: When all the files have been loaded.</li>
<li><code>willReady</code>: When all the plugins are ready.</li>
<li><code>didReady</code>: When all the workers are ready.</li>
<li><code>serverDidReady</code>: When the server is ready.</li>
<li><code>beforeClose</code>: Before the application is closed.</li>
</ul>
<p>Here're the definations:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app.js or agent.js</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AppBootHook</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(app) &#123;</span><br><span class="line">    <span class="keyword">this</span>.app = app;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  configWillLoad() &#123;</span><br><span class="line">    <span class="comment">// Ready to call configDidLoad,</span></span><br><span class="line">    <span class="comment">// Config, plugin files are referred,</span></span><br><span class="line">    <span class="comment">// this is the last chance to modify the config.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  configDidLoad() &#123;</span><br><span class="line">    <span class="comment">// Config, plugin files have been loaded.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> didLoad() &#123;</span><br><span class="line">    <span class="comment">// All files have loaded, start plugin here.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> willReady() &#123;</span><br><span class="line">    <span class="comment">// All plugins have started, can do some thing before app ready</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> didReady() &#123;</span><br><span class="line">    <span class="comment">// Worker is ready, can do some things</span></span><br><span class="line">    <span class="comment">// don't need to block the app boot.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> serverDidReady() &#123;</span><br><span class="line">    <span class="comment">// Server is listening.</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> beforeClose() &#123;</span><br><span class="line">    <span class="comment">// Do some thing before app close.</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = AppBootHook;</span><br></pre></td></tr></table></figure>
<p>The framework will automatically load and initialize this class after developers have defined <code>app.js</code> and <code>agenet.js</code> in the form of class, and it will call the corresponding methods during each of the life cycles.</p>
<p>Here's the image of starting process:</p>
<p><img src="https://user-images.githubusercontent.com/40081831/50559449-2d3cdc80-0d32-11e9-96f2-42b3cc56d5d3.png" alt></p>
<p><strong>Notice: We have an expiring time limitation when using <code>beforeClose</code> to close the processing of the framework. If a worker has accepted the signal of exit but doesn't exit within the limit period, it will be FORCELY closed.</strong></p>
<p>If you need to modify the expiring time, please see <a href="https://github.com/eggjs/egg-cluster" target="_blank" rel="noopener">this document</a>.</p>
<p>Deprecated methods:</p>
<h2 id="beforestart"><a class="markdown-anchor" href="#beforestart">#</a> <code>beforeStart</code></h2>
<p><code>beforeStart</code> is called during the loading process, all of its methods are running in parallel. So we usually execute some asynchronized methods (e.g: Check the state of connection, in <a href="https://github.com/eggjs/egg-mysql/blob/master/lib/mysql.js" target="_blank" rel="noopener"><code>egg-mysql</code></a> we use this method to check the connection state with mysql). When all the tasks in <code>beforeStart</code> finished, the state will be <code>ready</code>. It's NOT recommended to excute a function that consumes too much time there, which will cause the expiration of application's start.plugin developers should use <code>didLoad</code> instead, for application developers, <code>willReady</code> is the replacer.</p>
<h2 id="ready"><a class="markdown-anchor" href="#ready">#</a> <code>ready</code></h2>
<p>All the methods mounted on <code>ready</code> will be executed when load ends, and after all the methods in <code>beforeStart</code> have finished executing. By the time Http server's listening also starts. This means all the plugins are fully loaded and everything is ready, So we use it to process some tasks after start. For developers now, we use <code>didReady</code> instead.</p>
<h2 id="beforeclose"><a class="markdown-anchor" href="#beforeclose">#</a> <code>beforeClose</code></h2>
<p>All the methods mounted on <code>beforeClose</code> are called in an inverted order after <code>close</code> method in app/agent instance is called. E.g: in <a href="https://github.com/eggjs/egg/blob/master/lib/egg.js" target="_blank" rel="noopener"><code>egg</code></a>, we close logger, remove listening methods ...,ect.Developers SHOULDN'T use <code>app.beforeClose</code> directly now, but in the form of class to implement <code>beforeClose</code> instead.</p>
<p><strong>We don't recommend to use this function in a PROD env, because the process may end before it finishes.</strong></p>
<p>What's more, we can use <a href="https://github.com/eggjs/egg-development#loader-trace" target="_blank" rel="noopener"><code>egg-development</code></a> to see the loading process.</p>
<h3 id="file-loading-rules"><a class="markdown-anchor" href="#file-loading-rules">#</a> File-Loading Rules</h3>
<p>The framework will convert file names when loading files, because there is a difference between the file naming style and the API style. We recommend that files use underscores, while APIs use lower camel case. For examplem <code>app/service/user_info.js</code> will be converted to <code>app.service.userInfo</code>.</p>
<p>The framework also supports hyphens and camel case:</p>
<ul>
<li><code>app/service/user-info.js</code> =&gt; <code>app.service.userInfo</code></li>
<li><code>app/service/userInfo.js</code> =&gt; <code>app.service.userInfo</code></li>
</ul>
<p>Loader also provides <a href="#caseStyle-string">caseStyle</a> to force the first letter case, such as make the first letter of the API upper case when loading the model, <code>app/model/user.js</code> =&gt; <code>app.model.User</code>, we can set <code>caseStyle: 'upper'</code>.</p>
<h2 id="extend-loader"><a class="markdown-anchor" href="#extend-loader">#</a> Extend Loader</h2>
<p>[Loader] is a base class and provides some built-in methods based on the rules of the file loading, but itself does not call them in most cases, inherited classes call those methods.</p>
<ul>
<li>loadPlugin()</li>
<li>loadConfig()</li>
<li>loadAgentExtend()</li>
<li>loadApplicationExtend()</li>
<li>loadRequestExtend()</li>
<li>loadResponseExtend()</li>
<li>loadContextExtend()</li>
<li>loadHelperExtend()</li>
<li>loadCustomAgent()</li>
<li>loadCustomApp()</li>
<li>loadService()</li>
<li>loadMiddleware()</li>
<li>loadController()</li>
<li>loadRouter()</li>
</ul>
<p>Egg implements [AppWorkerLoader] and [AgentWorkerLoader] based on the Loader, inherited frameworks could make extensions based on these two classes, and <strong>Extensions of the Loader can only be done in the framework</strong>.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// custom AppWorkerLoader</span></span><br><span class="line"><span class="comment">// lib/framework.js</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">const</span> egg = <span class="built_in">require</span>(<span class="string">'egg'</span>);</span><br><span class="line"><span class="keyword">const</span> EGG_PATH = <span class="built_in">Symbol</span>.for(<span class="string">'egg#eggPath'</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">YadanAppWorkerLoader</span> <span class="keyword">extends</span> <span class="title">egg</span>.<span class="title">AppWorkerLoader</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(opt) &#123;</span><br><span class="line">    <span class="keyword">super</span>(opt);</span><br><span class="line">    <span class="comment">// custom initialization</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  loadConfig() &#123;</span><br><span class="line">    <span class="keyword">super</span>.loadConfig();</span><br><span class="line">    <span class="comment">// process config</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  load() &#123;</span><br><span class="line">    <span class="keyword">super</span>.load();</span><br><span class="line">    <span class="comment">// custom loading other directories</span></span><br><span class="line">    <span class="comment">// or processing loaded files</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">egg</span>.<span class="title">Application</span> </span>&#123;</span><br><span class="line">  <span class="keyword">get</span> [EGG_PATH]() &#123;</span><br><span class="line">    <span class="keyword">return</span> path.dirname(__dirname);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// override Egg's Loader, use this Loader when launching</span></span><br><span class="line">  <span class="keyword">get</span> [EGG_LOADER]() &#123;</span><br><span class="line">    <span class="keyword">return</span> YadanAppWorkerLoader;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="built_in">Object</span>.assign(egg, &#123;</span><br><span class="line">  Application,</span><br><span class="line">  <span class="comment">// custom Loader also need export, inherited framework make extensions based on it</span></span><br><span class="line">  AppWorkerLoader: YadanAppWorkerLoader,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>It's convenient for development team to customize loading via the Loader supported APIs. such as <code>this.model.xx</code>, <code>app/extend/filter.js</code> and so on.</p>
<p>The mention above is just a description of the Loader wording, please see <a href="./framework.html">Framework Development</a> for details.</p>
<h2 id="loader-api"><a class="markdown-anchor" href="#loader-api">#</a> Loader API</h2>
<p>Loader also supports some low level APIs to simplify code when extending, <a href="https://github.com/eggjs/egg-core#eggloader" target="_blank" rel="noopener">here</a> are all APIs.</p>
<h3 id="loadfile"><a class="markdown-anchor" href="#loadfile">#</a> <code>loadFile</code></h3>
<p>Used to load a file, such as loading <code>app/xx.js</code>:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/xx.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(app.config);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="comment">// app/xx.js, as an example, we could load this file in app.js</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">  app.loader.loadFile(path.join(app.config.baseDir, <span class="string">'app/xx.js'</span>));</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>If the file exports a function, then the function will be called with <code>app</code> as its parameter, otherwise uses this value directly.</p>
<h3 id="loadtoapp"><a class="markdown-anchor" href="#loadtoapp">#</a> <code>loadToApp</code></h3>
<p>Used to load files from a directory into the app, such as <code>app/controller/home.js</code> to <code>app.controller.home</code>.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="comment">// The following is just an example, using loadController to load controller in practice</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> directory = path.join(app.config.baseDir, <span class="string">'app/controller'</span>);</span><br><span class="line">  app.loader.loadToApp(directory, <span class="string">'controller'</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>The method has three parameters <code>loadToApp(directory, property, LoaderOptions)</code>:</p>
<ol>
<li>Directory could be String or Array, Loader will load files in those directories.</li>
<li>Property is app's property.</li>
<li><a href="#LoaderOptions">LoaderOptions</a> are some configurations.</li>
</ol>
<h3 id="loadtocontext"><a class="markdown-anchor" href="#loadtocontext">#</a> <code>loadToContext</code></h3>
<p>The difference between loadToApp and loadToContext is that loadToContext loads files into ctx instead of app, and it's a lazy loading. It puts files into a temp object when loading, and instantiates objects when calling ctx APIs.</p>
<p>We load service in this mode as an example:</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// The following is just an example, using loadService in practice</span></span><br><span class="line"><span class="comment">// app/service/user.js</span></span><br><span class="line"><span class="keyword">const</span> Service = <span class="built_in">require</span>(<span class="string">'egg'</span>).Service;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">module</span>.exports = UserService;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="comment">// get all loadUnit</span></span><br><span class="line"><span class="keyword">const</span> servicePaths = app.loader.getLoadUnits().map(<span class="function"><span class="params">unit</span> =&gt;</span> path.join(unit.path, <span class="string">'app/service'</span>));</span><br><span class="line"></span><br><span class="line">app.loader.loadToContext(servicePaths, <span class="string">'service'</span>, &#123;</span><br><span class="line">  <span class="comment">// service needs to inherit app.Service, so needs app as parameter</span></span><br><span class="line">  <span class="comment">// enable call will return UserService when loading</span></span><br><span class="line">  call: <span class="literal">true</span>,</span><br><span class="line">  <span class="comment">// loading file into app.serviceClasses</span></span><br><span class="line">  fieldClass: <span class="string">'serviceClasses'</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p><code>app.serviceClasses.user</code> becomes UserService after file loading, it instantiates UserService when calling <code>ctx.service.user</code>.
So this class will only be instantiated when first calling, and will be cached after instantiation, multiple calling same request will be instantiated only once.</p>
<h3 id="loaderoptions"><a class="markdown-anchor" href="#loaderoptions">#</a> LoaderOptions</h3>
<h4 id="ignore-string"><a class="markdown-anchor" href="#ignore-string">#</a> <code>ignore [String]</code></h4>
<p><code>ignore</code> could ignore some files, supports glob, the default is empty.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line">app.loader.loadToApp(directory, <span class="string">'controller'</span>, &#123;</span><br><span class="line">  <span class="comment">// ignore files in app/controller/util</span></span><br><span class="line">  ignore: <span class="string">'util/**'</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="initializer-function"><a class="markdown-anchor" href="#initializer-function">#</a> <code>initializer [Function]</code></h4>
<p>Processing each file exported values, the default is empty.</p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app/model/user.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(app, path) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Loading from app/model, could do some initializations when loading.</span></span><br><span class="line"><span class="keyword">const</span> directory = path.join(app.config.baseDir, <span class="string">'app/model'</span>);</span><br><span class="line">app.loader.loadToApp(directory, <span class="string">'model'</span>, &#123;</span><br><span class="line">  initializer(model, opt) &#123;</span><br><span class="line">    <span class="comment">// The first parameter is export's object</span></span><br><span class="line">    <span class="comment">// The second parameter is an object that only contains current file path.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> model(app, opt.path);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h4 id="casestyle-string"><a class="markdown-anchor" href="#casestyle-string">#</a> <code>caseStyle [String]</code></h4>
<p>File conversion rules, could be <code>camel</code>, <code>upper</code>, <code>lower</code>, the default is <code>camel</code>.</p>
<p>All three convert file name to camel case, but deal with the initials differently:</p>
<ul>
<li><code>camel</code>: initials unchanged.</li>
<li><code>upper</code>: initials upper case.</li>
<li><code>lower</code>: initials lower case.</li>
</ul>
<p>Loading different files uses different configurations:</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Configuration</th>
</tr>
</thead>
<tbody>
<tr>
<td>app/controller</td>
<td>lower</td>
</tr>
<tr>
<td>app/middleware</td>
<td>lower</td>
</tr>
<tr>
<td>app/service</td>
<td>lower</td>
</tr>
</tbody>
</table>
<h4 id="override-boolean"><a class="markdown-anchor" href="#override-boolean">#</a> <code>override [Boolean]</code></h4>
<p>Overriding or throwing exception when encounter existing files, the default is false.</p>
<p>For example, the <code>app/service/user.js</code> is both loaded by the application and the plugin, if the setting is true, the application will override the plugin, otherwise an error will be throwed when loading.</p>
<p>Loading different files uses different configurations:</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Configuration</th>
</tr>
</thead>
<tbody>
<tr>
<td>app/controller</td>
<td>true</td>
</tr>
<tr>
<td>app/middleware</td>
<td>false</td>
</tr>
<tr>
<td>app/service</td>
<td>false</td>
</tr>
</tbody>
</table>
<h4 id="call-boolean"><a class="markdown-anchor" href="#call-boolean">#</a> <code>call [Boolean]</code></h4>
<p>Calling when export's object is function, and get the return value, the default is true</p>
<p>Loading different files uses different configurations:</p>
<table>
<thead>
<tr>
<th>File</th>
<th>Configuration</th>
</tr>
</thead>
<tbody>
<tr>
<td>app/controller</td>
<td>true</td>
</tr>
<tr>
<td>app/middleware</td>
<td>false</td>
</tr>
<tr>
<td>app/service</td>
<td>true</td>
</tr>
</tbody>
</table>
<h2 id="customloader"><a class="markdown-anchor" href="#customloader">#</a> CustomLoader</h2>
<p>You can use <code>customLoader</code> instead of <code>loadToContext</code> and <code>loadToApp</code>.</p>
<p>When you define a loader with <code>loadToApp</code></p>
<figure class="highlight js"><table><tr><td class="code"><pre><span class="line"><span class="comment">// app.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> directory = path.join(app.config.baseDir, <span class="string">'app/adapter'</span>);</span><br><span class="line">  app.loader.loadToApp(directory, <span class="string">'adapter'</span>);</span><br><span class="line">&#125;;;</span><br></pre></td></tr></table></figure>
<p>Instead, you can define <code>customLoader</code></p>
<pre><code class="language-js">// config/config.default.js
module.exports = {
  customLoader: {
    // the property name when load to application, E.X. app.adapter
    adapter: {
      // relative to app.config.baseDir
      directory: 'app/adapter',
      // if inject is ctx, it will use loadToContext
      inject: 'app',
      // whether load the directory of the framework and plugin
      loadunit: false,
      // you can also use other LoaderOptions
   }
  },
};
``

[Loader]: https://github.com/eggjs/egg-core/blob/master/lib/loader/egg_loader.js
[AppWorkerLoader]: https://github.com/eggjs/egg/blob/master/lib/loader/app_worker_loader.js
[AgentWorkerLoader]: https://github.com/eggjs/egg/blob/master/lib/loader/agent_worker_loader.js
</code></pre>
    
        </article>  
      </div>      
  </div>

  <div class="toc" id="toc">
  <ol class="toc-detail"><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#application-framework-and-plugin"><span class="toc-detail-number">1.</span> <span class="toc-detail-text"># Application, Framework and Plugin</span></a></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#loadunit"><span class="toc-detail-number">2.</span> <span class="toc-detail-text"># LoadUnit</span></a><ol class="toc-detail-child"><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#file-order"><span class="toc-detail-number">2.1.</span> <span class="toc-detail-text"># File Order</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#life-cycles"><span class="toc-detail-number">2.2.</span> <span class="toc-detail-text"># Life Cycles</span></a></li></ol></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#beforestart"><span class="toc-detail-number">3.</span> <span class="toc-detail-text"># beforeStart</span></a></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#ready"><span class="toc-detail-number">4.</span> <span class="toc-detail-text"># ready</span></a></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#beforeclose"><span class="toc-detail-number">5.</span> <span class="toc-detail-text"># beforeClose</span></a><ol class="toc-detail-child"><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#file-loading-rules"><span class="toc-detail-number">5.1.</span> <span class="toc-detail-text"># File-Loading Rules</span></a></li></ol></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#extend-loader"><span class="toc-detail-number">6.</span> <span class="toc-detail-text"># Extend Loader</span></a></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#loader-api"><span class="toc-detail-number">7.</span> <span class="toc-detail-text"># Loader API</span></a><ol class="toc-detail-child"><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#loadfile"><span class="toc-detail-number">7.1.</span> <span class="toc-detail-text"># loadFile</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#loadtoapp"><span class="toc-detail-number">7.2.</span> <span class="toc-detail-text"># loadToApp</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#loadtocontext"><span class="toc-detail-number">7.3.</span> <span class="toc-detail-text"># loadToContext</span></a></li><li class="toc-detail-item toc-detail-level-3"><a class="toc-detail-link" href="#loaderoptions"><span class="toc-detail-number">7.4.</span> <span class="toc-detail-text"># LoaderOptions</span></a></li></ol></li><li class="toc-detail-item toc-detail-level-2"><a class="toc-detail-link" href="#customloader"><span class="toc-detail-number">8.</span> <span class="toc-detail-text"># CustomLoader</span></a></li></ol>
</div>

<script>

var tocContainer = document.getElementById('toc');
var tocDetail = document.getElementsByClassName('toc-detail')[0];

(function(){
  if(!tocDetail){
    tocContainer.style.display = 'none';
  }

  if(tocDetail){
    document.querySelectorAll('.toc-detail-text').forEach(function(element){
      element.innerText = element.innerText.replace('# ', '');
    });
  }
})();
</script>

</div>

  </div>
</body>
<script src="https://cdn.jsdelivr.net/docsearch.js/2/docsearch.min.js"></script>
<script>
docsearch({
  apiKey: '1561de31a86f79507ea00cdb54ce647c',
  indexName: 'eggjs',
  inputSelector: '#search-query',
});
</script>
<div class="cnzz">
<script src="https://s11.cnzz.com/z_stat.php?id=1261142226&web_id=1261142226" language="JavaScript"></script>
</div>

</html>
